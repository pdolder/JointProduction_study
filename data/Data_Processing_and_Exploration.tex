\documentclass[12pt]{article}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{times}
\usepackage{hyperref}
\usepackage{natbib}
\usepackage{amsmath}
\usepackage{fullpage}
\usepackage{pdflscape}
\usepackage{rotfloat}
\usepackage{listings}
\usepackage{wasysym}
\usepackage{wrapfig}
\usepackage{dcolumn}
\hypersetup{pdfpagemode=UseNone} % don't show bookmarks on initial view
\hypersetup{colorlinks, urlcolor={blue}}
% revise margins
\setlength{\headheight}{0.0in}
\setlength{\topmargin}{0.0in}
\setlength{\headsep}{0.0in}
\setlength{\textheight}{8.65in}
\setlength{\footskip}{0.35in}
\setlength{\oddsidemargin}{0.0in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textwidth}{6.5in}

\setlength{\parskip}{6pt}
\setlength{\parindent}{0pt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Processing and exploration for Celtic Sea fishery-independent trawl
	survey data}
\author{Paul J Dolder}
\date{\today}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}



\maketitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This document is to detail the processing steps and workng up of data for fitting
a geostatistical model (VAST; see \url{https://github.com/james-thorson/VAST}
for detail) to trawl survey data covering the Celtic Sea. \\

The following data sources were used:

\begin{itemize}
	\item ICES Datras
		(\url{http://www.ices.dk/marine-data/data-portals/Pages/DATRAS.aspx}
		exhchange data of Ifremer (France) EVHOE and Marine Institute
		(Ireland) IGFS fisheries-independent survey locations and catch
		records.
	\item Cefas (UK) collection of trawl survey locations and catch
		records.
	\item ICES Datras data product on estimated weights of fish at various
		lengths from the EVHOE survey series.
\end{itemize}

\section{Length-weight conversion factors}

As the survey records consist of count of fish at each length class and we are
interested in working with biomass (weight) of fish, we first estimate a
length-weight relationship for the different species from the Datras data
product of weight at length estimates. The data is baseds on the EVHOE survey
series only, due to availability within Datras. \\

A standard von bertalanffy length weight relationship was used, with two
parameters to estimate:

\begin{equation}\label{eq:1}
	Wt = a \cdot L^b
\end{equation}

The raw data looks as follows for cod, megrim, anglerfishes, haddock, whiting,
hake, plaice and sole:

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Read data and remove records without corresponding weight}
\hlstd{DF} \hlkwb{<-} \hlkwd{read.csv}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"SMALK_EVHOE.csv"}\hlstd{))}  \hlcom{# read data}
\hlstd{DF} \hlkwb{<-} \hlstd{DF[}\hlopt{!}\hlkwd{is.na}\hlstd{(DF}\hlopt{$}\hlstd{IndWgt), ]}

\hlcom{# Subset to species of interest sort(unique(DF$Species))}
\hlstd{spp} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"Gadus morhua"}\hlstd{,} \hlstr{"Lepidorhombus whiffiagonis"}\hlstd{,} \hlstr{"Lophius piscatorius"}\hlstd{,}
    \hlstr{"Lophius budegassa"}\hlstd{,} \hlstr{"Merlangius merlangus"}\hlstd{,} \hlstr{"Melanogrammus aeglefinus"}\hlstd{,}
    \hlstr{"Merluccius merluccius"}\hlstd{,} \hlstr{"Pleuronectes platessa"}\hlstd{,} \hlstr{"Solea solea"}\hlstd{)}

\hlcom{## N.B. The length-weight relationship for anglerfishes}
\hlcom{## doesn't hold, so we might need an alternative}
\hlcom{## solution....'Pollachius pollachius' - no juveniles??}

\hlstd{DF} \hlkwb{<-} \hlstd{DF[DF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{spp, ]}

\hlcom{# Plot}
\hlkwd{ggplot}\hlstd{(DF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= LngtClass,} \hlkwc{y} \hlstd{= IndWgt))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlkwd{factor}\hlstd{(Year)))} \hlopt{+}
    \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Species,} \hlkwc{scale} \hlstd{=} \hlstr{"free"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}
\end{alltt}
\end{kframe}\begin{figure}
\includegraphics[width=\maxwidth]{figure/LWt-1} \caption[Estimates of individual weights at length for the gadoid species]{Estimates of individual weights at length for the gadoid species. Colours indicate individual years measurements}\label{fig:LWt}
\end{figure}


\end{knitrout}

To simplify the fitting procedure, the von bertalanffy relationship in equation
\ref{eq:1} was rearranged to be linear on a log scale:

\begin{equation}\label{eq:2}
	log(Wt) = log(a) + b \cdot log(L) + \varepsilon
\end{equation} 

\vspace{1cm}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{DF}\hlopt{$}\hlstd{lWt} \hlkwb{<-} \hlkwd{log}\hlstd{(DF}\hlopt{$}\hlstd{IndWgt)}
\hlstd{DF}\hlopt{$}\hlstd{lL} \hlkwb{<-} \hlkwd{log}\hlstd{(DF}\hlopt{$}\hlstd{LngtClass)}

\hlkwd{ggplot}\hlstd{(DF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= lL,} \hlkwc{y} \hlstd{= lWt))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlkwd{factor}\hlstd{(Year)))} \hlopt{+}
    \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Species,} \hlkwc{scale} \hlstd{=} \hlstr{"free"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}
\end{alltt}
\end{kframe}
\includegraphics[width=\maxwidth]{figure/LWt2-1} 

\end{knitrout}

A linear model with species and year as factors was fit using the \textit{glm}
function in the base R package. We separate the roundfish and flatfish due to
the different morphological forms affecting the length weight relationship:

\begin{kframe}
\begin{alltt}
\hlstd{gads} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"Gadus morhua"}\hlstd{,} \hlstr{"Melanogrammus aeglefinus"}\hlstd{,} \hlstr{"Merluccius merluccius"}\hlstd{,}
    \hlstr{"Merlangius merlangus"}\hlstd{)}
\hlstd{flats} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"Lepidorhombus whiffiagonis"}\hlstd{,} \hlstr{"Solea solea"}\hlstd{,} \hlstr{"Pleuronectes platessa"}\hlstd{)}
\hlstd{lops} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"Lophius piscatorius"}\hlstd{,} \hlstr{"Lophius budegassa"}\hlstd{)}

\hlstd{lm1.gad} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species} \hlopt{+} \hlstd{Year,} \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%}
    \hlstd{gads))}
\hlstd{lm2.gad} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species,} \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%}
    \hlstd{gads))}

\hlkwd{stargazer}\hlstd{(lm1.gad, lm2.gad,} \hlkwc{font.size} \hlstd{=} \hlstr{"small"}\hlstd{,} \hlkwc{align} \hlstd{= T,} \hlkwc{title} \hlstd{=} \hlstr{"glm output from the two model fits to gadoids"}\hlstd{,}
    \hlkwc{table.placement} \hlstd{=} \hlstr{"H"}\hlstd{)}
\end{alltt}
\end{kframe}
% Table created by stargazer v.5.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: Thu, May 04, 2017 - 09:55:18
% Requires LaTeX packages: dcolumn 
\begin{table}[H] \centering 
  \caption{glm output from the two model fits to gadoids} 
  \label{} 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lD{.}{.}{-3} D{.}{.}{-3} } 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{lWt} \\ 
\\[-1.8ex] & \multicolumn{1}{c}{(1)} & \multicolumn{1}{c}{(2)}\\ 
\hline \\[-1.8ex] 
 lL & 3.085^{***} & 3.085^{***} \\ 
  & (0.005) & (0.005) \\ 
  & & \\ 
 SpeciesMelanogrammus aeglefinus & -0.015^{**} & -0.015^{**} \\ 
  & (0.007) & (0.007) \\ 
  & & \\ 
 SpeciesMerlangius merlangus & -0.199^{***} & -0.199^{***} \\ 
  & (0.008) & (0.008) \\ 
  & & \\ 
 SpeciesMerluccius merluccius & -0.435^{***} & -0.436^{***} \\ 
  & (0.149) & (0.149) \\ 
  & & \\ 
 Year & 0.0001 &  \\ 
  & (0.001) &  \\ 
  & & \\ 
 Constant & -12.263^{***} & -11.977^{***} \\ 
  & (1.607) & (0.034) \\ 
  & & \\ 
\hline \\[-1.8ex] 
Observations & \multicolumn{1}{c}{6,624} & \multicolumn{1}{c}{6,624} \\ 
Log Likelihood & \multicolumn{1}{c}{3,219.649} & \multicolumn{1}{c}{3,219.633} \\ 
Akaike Inf. Crit. & \multicolumn{1}{c}{-6,427.297} & \multicolumn{1}{c}{-6,429.266} \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 
\begin{kframe}\begin{alltt}
\hlstd{lm1.flat} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species} \hlopt{+} \hlstd{Year,} \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF,}
    \hlstd{Species} \hlopt{%in%} \hlstd{flats))}
\hlstd{lm2.flat} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species,} \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%}
    \hlstd{flats))}

\hlkwd{stargazer}\hlstd{(lm1.flat, lm2.flat,} \hlkwc{font.size} \hlstd{=} \hlstr{"small"}\hlstd{,} \hlkwc{align} \hlstd{= T,}
    \hlkwc{title} \hlstd{=} \hlstr{"glm output from the two model fits to flatfish"}\hlstd{,}
    \hlkwc{table.placement} \hlstd{=} \hlstr{"H"}\hlstd{)}
\end{alltt}
\end{kframe}
% Table created by stargazer v.5.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: Thu, May 04, 2017 - 09:55:25
% Requires LaTeX packages: dcolumn 
\begin{table}[H] \centering 
  \caption{glm output from the two model fits to flatfish} 
  \label{} 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lD{.}{.}{-3} D{.}{.}{-3} } 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{lWt} \\ 
\\[-1.8ex] & \multicolumn{1}{c}{(1)} & \multicolumn{1}{c}{(2)}\\ 
\hline \\[-1.8ex] 
 lL & 3.106^{***} & 3.106^{***} \\ 
  & (0.010) & (0.010) \\ 
  & & \\ 
 SpeciesPleuronectes platessa & 0.361^{***} & 0.358^{***} \\ 
  & (0.013) & (0.012) \\ 
  & & \\ 
 SpeciesSolea solea & 0.190^{***} & 0.188^{***} \\ 
  & (0.009) & (0.009) \\ 
  & & \\ 
 Year & -0.001 &  \\ 
  & (0.002) &  \\ 
  & & \\ 
 Constant & -9.739^{***} & -12.410^{***} \\ 
  & (3.147) & (0.056) \\ 
  & & \\ 
\hline \\[-1.8ex] 
Observations & \multicolumn{1}{c}{3,180} & \multicolumn{1}{c}{3,180} \\ 
Log Likelihood & \multicolumn{1}{c}{753.089} & \multicolumn{1}{c}{752.728} \\ 
Akaike Inf. Crit. & \multicolumn{1}{c}{-1,496.177} & \multicolumn{1}{c}{-1,497.456} \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 


Year was initially also included as a factor, but found not to be significant
and the second, across year, fit was chosen as the best models (Table 1, Table
2). These models were then used to predict over all lengths for each species.  A
bias correction was applied to adjust for the fact that the mean weights from
the model fit on a log scale are geometric means on the normal scale (cf =
$e^{\frac{\sigma^{2}}{2}}$).

For anglerfish, as there is insufficient data for a fit a model (few data
points for piscatorius, no data points for budegassa), we use estimates from
fishbase: $a = 0.03330$, $b= 2.766$.

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{lop} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwc{a} \hlstd{=} \hlnum{0.0333}\hlstd{,} \hlkwc{b} \hlstd{=} \hlnum{2.766}\hlstd{)}

\hlstd{predDF} \hlkwb{<-} \hlkwd{expand.grid}\hlstd{(}\hlkwc{lL} \hlstd{=} \hlkwd{seq}\hlstd{(}\hlkwd{log}\hlstd{(}\hlkwd{min}\hlstd{(DF}\hlopt{$}\hlstd{LngtClass)),} \hlkwd{log}\hlstd{(}\hlkwd{max}\hlstd{(DF}\hlopt{$}\hlstd{LngtClass)),}
    \hlkwc{l} \hlstd{=} \hlnum{80}\hlstd{),} \hlkwc{Species} \hlstd{= spp)}

\hlstd{predDF}\hlopt{$}\hlstd{lWt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2.gad,} \hlkwc{newdata} \hlstd{= predDF[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{gads, ])}
\hlstd{predDF}\hlopt{$}\hlstd{lWt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2.flat,} \hlkwc{newdata} \hlstd{= predDF[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{flats, ])}
\hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]} \hlkwb{<-} \hlstd{lop[[}\hlstr{"a"}\hlstd{]]} \hlopt{*} \hlstd{(}\hlkwd{exp}\hlstd{(predDF}\hlopt{$}\hlstd{lL[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{lops])}\hlopt{^}\hlstd{lop[[}\hlstr{"b"}\hlstd{]])}\hlopt{/}\hlnum{1000}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Exponentiate the predictions}
\hlstd{predDF}\hlopt{$}\hlstd{L} \hlkwb{<-} \hlkwd{exp}\hlstd{(predDF}\hlopt{$}\hlstd{lL)}
\hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlkwd{c}\hlstd{(gads, flats)]} \hlkwb{<-} \hlkwd{exp}\hlstd{(predDF}\hlopt{$}\hlstd{lWt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlkwd{c}\hlstd{(gads, flats)])}

\hlcom{## Now we need to bias correct due to the fact that the mean}
\hlcom{## on the logscale is the geometric mean...}
\hlstd{corr.fact.gad} \hlkwb{<-} \hlkwd{exp}\hlstd{(}\hlkwd{sigma}\hlstd{(lm2.gad)}\hlopt{^}\hlnum{2}\hlopt{/}\hlnum{2}\hlstd{)}
\hlstd{corr.fact.flat} \hlkwb{<-} \hlkwd{exp}\hlstd{(}\hlkwd{sigma}\hlstd{(lm2.flat)}\hlopt{^}\hlnum{2}\hlopt{/}\hlnum{2}\hlstd{)}
\hlkwd{print}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{"Correction factor for gadoids="}\hlstd{,} \hlkwd{round}\hlstd{(corr.fact.gad,}
    \hlnum{3}\hlstd{),} \hlstr{"and flats = "}\hlstd{,} \hlkwd{round}\hlstd{(corr.fact.flat,} \hlnum{3}\hlstd{)))}
\end{alltt}
\begin{verbatim}
## [1] "Correction factor for gadoids= 1.011 and flats =  1.018"
\end{verbatim}
\begin{alltt}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{gads]} \hlopt{*} \hlstd{corr.fact.gad}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{flats]} \hlopt{*} \hlstd{corr.fact.flat}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]} \hlkwb{<-} \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{lops]}

\hlcom{# Plot the von bertalanffy fits}
\hlkwd{ggplot}\hlstd{(DF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= LngtClass,} \hlkwc{y} \hlstd{= IndWgt))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlstr{"grey"}\hlstd{)} \hlopt{+}
    \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Species,} \hlkwc{scale} \hlstd{=} \hlstr{"free"}\hlstd{)} \hlopt{+} \hlkwd{geom_line}\hlstd{(}\hlkwc{data} \hlstd{= predDF,}
    \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= L,} \hlkwc{y} \hlstd{= Wt),} \hlkwc{col} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{geom_line}\hlstd{(}\hlkwc{data} \hlstd{= predDF,}
    \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= L,} \hlkwc{y} \hlstd{= WtCorr),} \hlkwc{col} \hlstd{=} \hlstr{"blue"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}
\end{alltt}
\end{kframe}
\includegraphics[width=\maxwidth]{figure/Predictions2-1} 
\begin{kframe}\begin{alltt}
\hlstd{lm2} \hlkwb{<-} \hlkwd{list}\hlstd{(lm2.gad, lm2.flat)}
\hlstd{corr.fact} \hlkwb{<-} \hlkwd{list}\hlstd{(corr.fact.gad, corr.fact.flat)}

\hlcom{## Save the fit and the correction factor}
\hlkwd{save}\hlstd{(lm2, corr.fact, lop,} \hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"LengthWeightPredictCelticSea.RData"}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{DATRAS data processing}

Next the ICES Datras database was queried for all survey data from the Celtic
Sea, extracting the haul data with the function \textit{getHHdata} and the
catch data using the function \textit{getHLdata} from the package
\textit{icesDatras}. \\

The objective was to check, clean and format the data into suitable input data
for the VAST model. For the Datras data this involved:

\begin{itemize}
	\item Only retain valid hauls (excluding those at night, where there
		were problems with the gear etc..)
	\item As we want point data, calculate the midpoint of each tow based
		on the geodesic distance (also estimating any missing data on
		distance towed).
	\item In order to calculate swept area, obtain model estimates for any
		missing data points on door spread through modelling the
		relationship between depth and door spread.
	\item Calculate swept area for each tow in the surveys.
	\item Estimate weight at length using the length weight relationship
		predictions obtained from equation \ref{eq:1} above.
	\item Raise the data to weight, partioned between adult and juvenile fish.
	\item Merge station and catch data ensuring there is one record per
		species for each of the stations fished (including where there
		were zero catches).
\end{itemize}

\subsection{Midpoint of tows}

To calculate the tow midpoints, we assume tows are in a straight line and use
the haversine formula (based on location in radians) to calculate the total distance.

\begin{equation}
	Loc(R) = Loc(D) \cdot \frac{\pi}{180}
\end{equation}

Where R and D are radians and decimal degrees respectively. \\

To calculate the distance:

\begin{equation}
	\begin{split}
	& f D(km) = \\
	& R \cdot \Bigg[2 \cdot \arcsin \Bigg(\min\bigg(1,
	\sqrt{\sin({\frac{Lat_{y1} - Lat_{y2}}{2}})^2 + \cos(Lat_{x1}) \cdot
		\cos(Lat_{x2}) \cdot \sin({\frac{Lon_{x1} -
				Lon_{x2}}{2})^2}}\bigg)\Bigg)\Bigg]
\end{split}
\end{equation}

Where $R$ is the mean Radius of the Earth, 6 341 km. \\

Total records were: \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{load}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"CelticSurveyData.RData"}\hlstd{))}  \hlcom{# pre-downloaded data, HH is station, HL is catch}

\hlkwd{kable}\hlstd{(}\hlkwd{group_by}\hlstd{(HH, Survey, HaulVal)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{n} \hlstd{=} \hlkwd{n}\hlstd{()))}
\end{alltt}
\end{kframe}
\begin{tabular}{l|l|r}
\hline
Survey & HaulVal & n\\
\hline
EVHOE & I & 2\\
\hline
EVHOE & V & 2643\\
\hline
IE-IGFS & V & 2118\\
\hline
\end{tabular}

\begin{kframe}\begin{alltt}
\hlcom{## Some initial cleaning}
\hlstd{HH} \hlkwb{<-} \hlkwd{filter}\hlstd{(HH, HaulVal} \hlopt{==} \hlstr{"V"}\hlstd{)}  \hlcom{# only valid hauls}

\hlcom{# Convert degrees to radians}
\hlstd{deg2rad} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{deg}\hlstd{)} \hlkwd{return}\hlstd{(deg} \hlopt{*} \hlstd{pi}\hlopt{/}\hlnum{180}\hlstd{)}

\hlcom{# Calculates the geodesic distance between two points}
\hlcom{# specified by radian latitude/longitude using the Haversine}
\hlcom{# formula (hf)}
\hlstd{gcd.hf} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{long1}\hlstd{,} \hlkwc{lat1}\hlstd{,} \hlkwc{long2}\hlstd{,} \hlkwc{lat2}\hlstd{) \{}
    \hlstd{R} \hlkwb{<-} \hlnum{6371}  \hlcom{# Earth mean radius [km]}
    \hlstd{delta.long} \hlkwb{<-} \hlstd{(long2} \hlopt{-} \hlstd{long1)}
    \hlstd{delta.lat} \hlkwb{<-} \hlstd{(lat2} \hlopt{-} \hlstd{lat1)}
    \hlstd{a} \hlkwb{<-} \hlkwd{sin}\hlstd{(delta.lat}\hlopt{/}\hlnum{2}\hlstd{)}\hlopt{^}\hlnum{2} \hlopt{+} \hlkwd{cos}\hlstd{(lat1)} \hlopt{*} \hlkwd{cos}\hlstd{(lat2)} \hlopt{*} \hlkwd{sin}\hlstd{(delta.long}\hlopt{/}\hlnum{2}\hlstd{)}\hlopt{^}\hlnum{2}
    \hlstd{c} \hlkwb{<-} \hlnum{2} \hlopt{*} \hlkwd{asin}\hlstd{(}\hlkwd{min}\hlstd{(}\hlnum{1}\hlstd{,} \hlkwd{sqrt}\hlstd{(a)))}
    \hlstd{d} \hlkwb{=} \hlstd{R} \hlopt{*} \hlstd{c}
    \hlkwd{return}\hlstd{(d)}  \hlcom{# Distance in km}
\hlstd{\}}
\hlcom{############################ }
\hlstd{an} \hlkwb{<-} \hlstd{as.numeric}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HH}\hlopt{$}\hlstd{Dist} \hlkwb{<-} \hlkwd{mapply}\hlstd{(gcd.hf,} \hlkwc{long1} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLong)),}
    \hlkwc{lat1} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLat)),} \hlkwc{long2} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLong)),}
    \hlkwc{lat2} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLat)))}

\hlkwd{plot}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{Distance[(HH}\hlopt{$}\hlstd{Distance} \hlopt{!= -}\hlnum{9}\hlstd{)])}\hlopt{/}\hlnum{1000} \hlopt{~} \hlstd{HH}\hlopt{$}\hlstd{Dist[(HH}\hlopt{$}\hlstd{Distance} \hlopt{!=}
    \hlopt{-}\hlnum{9}\hlstd{)],} \hlkwc{main} \hlstd{=} \hlstr{"Recorded vs calculated distance"}\hlstd{,} \hlkwc{ylab} \hlstd{=} \hlstr{"Recorded distance"}\hlstd{,}
    \hlkwc{xlab} \hlstd{=} \hlstr{"Calculated distance"}\hlstd{,} \hlkwc{cex} \hlstd{=} \hlnum{0.7}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Distances2-1} 

}


\begin{kframe}\begin{alltt}
\hlcom{## Looks good - use the calculated estimates ##}
\end{alltt}
\end{kframe}
\end{knitrout}

\subsection{Swept area}

To calculate the swept area, we first have to estimate the door spread for any
records where it's missing. There were only 5 records with missing door spread,
but use the predicted door spread for all records. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Covert numeric variables so we can explore the covariates}
\hlstd{HH}\hlopt{$}\hlstd{SweepLngt} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SweepLngt)}
\hlstd{HH}\hlopt{$}\hlstd{HaulDur} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{HaulDur)}
\hlstd{HH}\hlopt{$}\hlstd{DoorSpread} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{DoorSpread)}
\hlstd{HH}\hlopt{$}\hlstd{Depth} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{Depth)}
\hlstd{HH}\hlopt{$}\hlstd{Netopening} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{Netopening)}
\hlstd{HH}\hlopt{$}\hlstd{Warplngt} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{Warplngt)}
\hlstd{HH}\hlopt{$}\hlstd{Warpdia} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{Warpdia)}
\hlstd{HH}\hlopt{$}\hlstd{DoorSurface} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{DoorSurface)}
\hlstd{HH}\hlopt{$}\hlstd{DoorWgt} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{DoorWgt)}
\hlstd{HH}\hlopt{$}\hlstd{WingSpread} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{WingSpread)}
\hlstd{HH}\hlopt{$}\hlstd{KiteDim} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{KiteDim)}
\hlstd{HH}\hlopt{$}\hlstd{TowDir} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{TowDir)}
\hlstd{HH}\hlopt{$}\hlstd{GroundSpeed} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{GroundSpeed)}
\hlstd{HH}\hlopt{$}\hlstd{SpeedWater} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SpeedWater)}
\hlstd{HH}\hlopt{$}\hlstd{SurCurDir} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SurCurDir)}
\hlstd{HH}\hlopt{$}\hlstd{SurCurSpeed} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SurCurSpeed)}
\hlstd{HH}\hlopt{$}\hlstd{BotCurDir} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{BotCurDir)}
\hlstd{HH}\hlopt{$}\hlstd{BotCurSpeed} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{BotCurSpeed)}
\hlstd{HH}\hlopt{$}\hlstd{WindDir} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{WindDir)}
\hlstd{HH}\hlopt{$}\hlstd{WindSpeed} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{WindSpeed)}
\hlstd{HH}\hlopt{$}\hlstd{SwellDir} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SwellDir)}
\hlstd{HH}\hlopt{$}\hlstd{SwellHeight} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SwellHeight)}
\hlstd{HH}\hlopt{$}\hlstd{SurTemp} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SurTemp)}
\hlstd{HH}\hlopt{$}\hlstd{BotTemp} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{BotTemp)}
\hlstd{HH}\hlopt{$}\hlstd{SurSal} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{SurSal)}
\hlstd{HH}\hlopt{$}\hlstd{BotSal} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(HH}\hlopt{$}\hlstd{BotSal)}

\hlstd{HH[HH} \hlopt{== -}\hlnum{9}\hlstd{]} \hlkwb{<-} \hlnum{NA}

\hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Depth,} \hlkwc{y} \hlstd{= DoorSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{()} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
    \hlkwd{ggtitle}\hlstd{(}\hlstr{"Relationship between depth of gear and
     door spread"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/DoorSpread-1} 

}



\end{knitrout}

There may be another covariate affecting doorspread, indicated by the
clustering of some of the data...lets look at some of them.

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{p1} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Depth,} \hlkwc{y} \hlstd{= DoorSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlkwd{factor}\hlstd{(DoorWgt)))} \hlopt{+}
    \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"..with door weight"}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.position} \hlstd{=} \hlstr{"top"}\hlstd{)}

\hlstd{p2} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Depth,} \hlkwc{y} \hlstd{= DoorSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{= Warplngt))} \hlopt{+}
    \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"..with warp length"}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.position} \hlstd{=} \hlstr{"top"}\hlstd{)}

\hlstd{p3} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Depth,} \hlkwc{y} \hlstd{= DoorSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlkwd{factor}\hlstd{(Warpdia)))} \hlopt{+}
    \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"..with warp diameter"}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.position} \hlstd{=} \hlstr{"top"}\hlstd{)}

\hlstd{p4} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Depth,} \hlkwc{y} \hlstd{= DoorSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlkwd{factor}\hlstd{(SweepLngt)))} \hlopt{+}
    \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"..with warp sweep length"}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.position} \hlstd{=} \hlstr{"top"}\hlstd{)}

\hlkwd{grid.arrange}\hlstd{(p1, p2, p3, p4,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/DoorSpread2-1} 

}



\end{knitrout}

There looks to be a relationship between depth and doorspread where it
increases to around 200 m and then flattens out, but with a covariate effect.
We will model this relationship with a gam. 

\begin{kframe}
\begin{alltt}
\hlcom{# Without covariate}
\hlstd{m1} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlkwd{s}\hlstd{(Depth),} \hlkwc{data} \hlstd{= HH)}
\hlcom{# summary(m1)}

\hlcom{# With all covariate, no interactions}
\hlstd{m2} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlkwd{s}\hlstd{(Depth)} \hlopt{+} \hlkwd{factor}\hlstd{(DoorWgt)} \hlopt{+} \hlstd{Warplngt} \hlopt{+}
    \hlkwd{factor}\hlstd{(Warpdia)} \hlopt{+} \hlkwd{factor}\hlstd{(SweepLngt),} \hlkwc{data} \hlstd{= HH)}
\hlcom{# summary(m2)}

\hlcom{### full interactions}
\hlstd{m3} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlkwd{s}\hlstd{(Depth)} \hlopt{+} \hlkwd{factor}\hlstd{(DoorWgt)} \hlopt{*} \hlstd{Warplngt} \hlopt{*}
    \hlkwd{factor}\hlstd{(Warpdia)} \hlopt{*} \hlkwd{factor}\hlstd{(SweepLngt),} \hlkwc{data} \hlstd{= HH)}
\hlcom{# summary(m3)}
\end{alltt}
\end{kframe}

\begin{kframe}
\begin{alltt}
\hlkwd{kable}\hlstd{(}\hlkwd{AIC}\hlstd{(m1, m2, m3))}
\end{alltt}
\end{kframe}
\begin{tabular}{l|r|r}
\hline
  & df & AIC\\
\hline
m1 & 10.37315 & 31310.46\\
\hline
m2 & 14.90415 & 24524.39\\
\hline
m3 & 20.57980 & 24261.34\\
\hline
\end{tabular}

\begin{kframe}\begin{alltt}
\hlcom{# stargazer(m1,m2,m3, font.size = 'small', align = T, title =}
\hlcom{# 'gam output from model with and without covariates',}
\hlcom{# table.placement = 'H', single.row = T)}
\end{alltt}
\end{kframe}

Full model looks best, but let's check the residuals against the covariates
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HHresid} \hlkwb{<-} \hlkwd{filter}\hlstd{(HH,} \hlopt{!}\hlkwd{is.na}\hlstd{(DoorWgt),} \hlopt{!}\hlkwd{is.na}\hlstd{(Warplngt),} \hlopt{!}\hlkwd{is.na}\hlstd{(Warpdia),}
    \hlopt{!}\hlkwd{is.na}\hlstd{(SweepLngt),} \hlopt{!}\hlkwd{is.na}\hlstd{(Depth),} \hlopt{!}\hlkwd{is.na}\hlstd{(DoorSpread))}

\hlstd{HHresid}\hlopt{$}\hlstd{residm3} \hlkwb{<-} \hlkwd{resid}\hlstd{(m3)}
\hlstd{HHresid}\hlopt{$}\hlstd{predictm3} \hlkwb{<-} \hlkwd{fitted}\hlstd{(m3)}

\hlcom{## Plot resids}
\hlkwd{ggplot}\hlstd{(HHresid,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= predictm3,} \hlkwc{y} \hlstd{= residm3))} \hlopt{+} \hlkwd{geom_point}\hlstd{()} \hlopt{+}
    \hlkwd{geom_smooth}\hlstd{(}\hlkwc{method} \hlstd{=} \hlstr{"loess"}\hlstd{,} \hlkwc{col} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
    \hlkwd{ggtitle}\hlstd{(}\hlstr{"fitted values against residuals"}\hlstd{)} \hlopt{+} \hlkwd{geom_hline}\hlstd{(}\hlkwc{yintercept} \hlstd{=} \hlnum{0}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Residualcheck-1} 

}


\begin{kframe}\begin{alltt}
\hlstd{p1} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HHresid,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{=} \hlkwd{factor}\hlstd{(DoorWgt),} \hlkwc{y} \hlstd{= residm3))} \hlopt{+}
    \hlkwd{geom_boxplot}\hlstd{()} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}

\hlstd{p2} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HHresid,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Warplngt,} \hlkwc{y} \hlstd{= residm3))} \hlopt{+} \hlkwd{geom_point}\hlstd{()} \hlopt{+}
    \hlkwd{geom_smooth}\hlstd{(}\hlkwc{method} \hlstd{=} \hlstr{"loess"}\hlstd{,} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
    \hlkwd{geom_hline}\hlstd{(}\hlkwc{yintercept} \hlstd{=} \hlnum{0}\hlstd{)}

\hlstd{p3} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HHresid,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{=} \hlkwd{factor}\hlstd{(Warpdia),} \hlkwc{y} \hlstd{= residm3))} \hlopt{+}
    \hlkwd{geom_boxplot}\hlstd{()} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}

\hlstd{p4} \hlkwb{<-} \hlkwd{ggplot}\hlstd{(HHresid,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{=} \hlkwd{factor}\hlstd{(SweepLngt),} \hlkwc{y} \hlstd{= residm3))} \hlopt{+}
    \hlkwd{geom_boxplot}\hlstd{()} \hlopt{+} \hlkwd{theme_bw}\hlstd{()}

\hlkwd{grid.arrange}\hlstd{(p1, p2, p3, p4,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Residualcheck-2} 

}



\end{knitrout}

Residuals look OK, so let's look at a Q-Q plot, half-normal plot and check the
predictions against the measurements...

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{qq.gam}\hlstd{(m3,} \hlkwc{main} \hlstd{=} \hlstr{"Q-Q plot"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Doorspread5-1} 

}


\begin{kframe}\begin{alltt}
\hlstd{faraway}\hlopt{::}\hlkwd{halfnorm}\hlstd{(}\hlkwd{resid}\hlstd{(m3),} \hlkwc{main} \hlstd{=} \hlstr{"Half-normal plot"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Doorspread5-2} 

}


\begin{kframe}\begin{alltt}
\hlstd{HH}\hlopt{$}\hlstd{PredSpread} \hlkwb{<-} \hlkwd{predict}\hlstd{(m3,} \hlkwc{newdata} \hlstd{= HH)}

\hlkwd{ggplot}\hlstd{(HH,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= DoorSpread,} \hlkwc{y} \hlstd{= PredSpread))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlstr{"grey"}\hlstd{)} \hlopt{+}
    \hlkwd{geom_abline}\hlstd{(}\hlkwc{slope} \hlstd{=} \hlnum{1}\hlstd{,} \hlkwc{intercept} \hlstd{=} \hlnum{0}\hlstd{,} \hlkwc{col} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
    \hlkwd{ylab}\hlstd{(}\hlstr{"Predicted door spread"}\hlstd{)} \hlopt{+} \hlkwd{xlab}\hlstd{(}\hlstr{"Measured door spred"}\hlstd{)} \hlopt{+}
    \hlkwd{ggtitle}\hlstd{(}\hlstr{"Door spread predictions against measurements"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Doorspread5-3} 

}


\begin{kframe}\begin{alltt}
\hlkwd{nrow}\hlstd{(HH[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread), ])}
\end{alltt}
\begin{verbatim}
## [1] 209
\end{verbatim}
\begin{alltt}
\hlstd{HH}\hlopt{$}\hlstd{PredSpread[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread)} \hlopt{& !}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{DoorSpread)]} \hlkwb{<-} \hlstd{HH}\hlopt{$}\hlstd{DoorSpread[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread)} \hlopt{&}
    \hlopt{!}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{DoorSpread)]}

\hlkwd{nrow}\hlstd{(HH[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread), ])}  \hlcom{# leaves 17 values}
\end{alltt}
\begin{verbatim}
## [1] 17
\end{verbatim}
\begin{alltt}
\hlcom{# Use simple depth relationship (m1) where possible}
\hlstd{HH}\hlopt{$}\hlstd{PredSpread[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread)} \hlopt{& !}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{Depth)]} \hlkwb{<-} \hlkwd{predict}\hlstd{(m1,}
    \hlkwc{newdata} \hlstd{= HH[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread)} \hlopt{& !}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{Depth), ])}

\hlcom{# For the remainder, use the standard 87 estimate}
\hlstd{HH}\hlopt{$}\hlstd{PredSpread[}\hlkwd{is.na}\hlstd{(HH}\hlopt{$}\hlstd{PredSpread)]} \hlkwb{<-} \hlnum{87}
\end{alltt}
\end{kframe}
\end{knitrout}

Looks OK.  We use this to predict the door spread for the tows (filling some
NAs without available covariates). Then, we calculate swept area based on:

\begin{equation}
	Swept Area (km^2) = Distance (km) \cdot \frac{Doorspread (m)}{1000}
	\cdot CF 
\end{equation}

Where CF is a correction factor for the efficiency of the gear, taken from Piet
et al as 0.38 for otter trawl gears. \textcolor{red}{ADD REF}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HH}\hlopt{$}\hlstd{SweptArea} \hlkwb{<-} \hlstd{HH}\hlopt{$}\hlstd{Dist} \hlopt{*} \hlstd{HH}\hlopt{$}\hlstd{PredSpread}\hlopt{/}\hlnum{1000}

\hlstd{HH}\hlopt{$}\hlstd{SweptAreaAdjFac} \hlkwb{<-} \hlnum{0.38}
\hlstd{HH}\hlopt{$}\hlstd{SweptAreaAdj} \hlkwb{<-} \hlstd{HH}\hlopt{$}\hlstd{SweptArea} \hlopt{*} \hlstd{HH}\hlopt{$}\hlstd{SweptAreaAdjFac}

\hlkwd{boxplot}\hlstd{(HH}\hlopt{$}\hlstd{SweptAreaAdj} \hlopt{~} \hlstd{HH}\hlopt{$}\hlstd{Survey,} \hlkwc{ylab} \hlstd{=} \hlstr{"Area Swept (km2)"}\hlstd{,}
    \hlkwc{xlab} \hlstd{=} \hlstr{"Survey series"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/SweptArea-1} 

}



\end{knitrout}

\subsection{Converting to weight}

The length data were converted to weight through the following process:

\begin{itemize}
	\item Standardise unit of measurement to cm
	\item Add .5cm to each length group to reflect the fact that lengths
		are rounded down on measurement.
	\item Adjusting one outlier (a single whiting of 2.5 m, an order
		greater than actual length) 
	\item Predict weights from the length weight relationships obtained
		above using equation \ref{eq:1}.
	\item Multiply the number caught at length by the subfactor (fraction
		measured at length from the haul) and by the predicted weight
		at length, converting to KG.
	\item Relabel the species to reflect if they are juvenile or adult
		length. The lengths to define this split were based on the EU
		technical regulation defining the minimum conservation
		reference size (MCRS); for cod = 35 cm, haddock = 30 cm,
		whiting = 27 cm, hake = 27 cm, plaice = 27 cm, sole = 24 cm,
		megrim = 20 cm. For anglerfishes (piscatorius and budegassa) at
		value of 32 cm was used, equivalent to the 500 g minimum
		marketing weight.
	\item Aggregate across length classes by species.
	\item Merge the station information with the catch records, retaining
		zero entries for each species at each station, where
		appropriate.
	\item Retaining all stations within 12 W - 2 W \&  48 N - 52 N (the
		Celtic Sea area).
\end{itemize}

The output from an estimation of the length at minimum marketing size for
anglerfishes was as follows:

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{## Add species names}
\hlkwd{load}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"DatrasSpeciesCodes.RData"}\hlstd{))}
\hlstd{HL}\hlopt{$}\hlstd{SpeciesName} \hlkwb{<-} \hlstd{DatrasSpeciesCodes}\hlopt{$}\hlstd{scientific.name[}\hlkwd{match}\hlstd{(HL}\hlopt{$}\hlstd{SpecCode,}
    \hlstd{DatrasSpeciesCodes}\hlopt{$}\hlstd{code_number)]}

\hlcom{# need as numeric}
\hlstd{an} \hlkwb{<-} \hlstd{as.numeric}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlkwb{<-} \hlkwd{an}\hlstd{(HL}\hlopt{$}\hlstd{LngtClass)}
\hlstd{HL}\hlopt{$}\hlstd{HLNoAtLngt} \hlkwb{<-} \hlkwd{an}\hlstd{(HL}\hlopt{$}\hlstd{HLNoAtLngt)}
\hlstd{HL}\hlopt{$}\hlstd{SubFactor} \hlkwb{<-} \hlkwd{an}\hlstd{(HL}\hlopt{$}\hlstd{SubFactor)}

\hlcom{# Deal with different length codes - standarise to cm}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass[(HL}\hlopt{$}\hlstd{LngtClass} \hlopt{==} \hlnum{2460} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Merlangius merlangus"}\hlstd{)]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{LngtClass[(HL}\hlopt{$}\hlstd{LngtClass} \hlopt{==}
    \hlnum{2460} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Merlangius merlangus"}\hlstd{)]}\hlopt{/}\hlnum{10}  \hlcom{## Dodgy datapoint!}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{==} \hlstr{". "}\hlstd{]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{==}
    \hlstr{". "}\hlstd{]}\hlopt{/}\hlnum{10}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{==} \hlnum{0}\hlstd{]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{==}
    \hlnum{0}\hlstd{]}\hlopt{/}\hlnum{10}

\hlcom{# Round down length classes & add 0.5}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{!=} \hlstr{"5"}\hlstd{]} \hlkwb{<-} \hlkwd{round}\hlstd{(HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{!=}
    \hlstr{"5"}\hlstd{])}
\hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{!=} \hlstr{"5"}\hlstd{]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{LngtCode} \hlopt{!=}
    \hlstr{"5"}\hlstd{]} \hlopt{+} \hlnum{0.5}

\hlcom{## Now raise with the Model predictions}
\hlkwd{load}\hlstd{(}\hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"LengthWeightPredictCelticSea.RData"}\hlstd{))}

\hlcom{# Filter to the species of interest}
\hlstd{HL}\hlopt{$}\hlstd{Species} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{SpeciesName}
\hlstd{HL} \hlkwb{<-} \hlkwd{filter}\hlstd{(HL, Species} \hlopt{%in%} \hlstd{spp)}  \hlcom{## spp from above}

\hlcom{# Add log(length)}
\hlstd{HL}\hlopt{$}\hlstd{lL} \hlkwb{<-} \hlkwd{log}\hlstd{(HL}\hlopt{$}\hlstd{LngtClass} \hlopt{*} \hlnum{10}\hlstd{)}

\hlcom{# Predict log weight gadoids}
\hlstd{HL}\hlopt{$}\hlstd{LogWtLength[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2[[}\hlnum{1}\hlstd{]],} \hlkwc{newdata} \hlstd{= HL[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{gads, ])}
\hlcom{# flats}
\hlstd{HL}\hlopt{$}\hlstd{LogWtLength[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2[[}\hlnum{2}\hlstd{]],} \hlkwc{newdata} \hlstd{= HL[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{flats, ])}
\hlcom{# anglerfishes}
\hlstd{HL}\hlopt{$}\hlstd{WtLength[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]} \hlkwb{<-} \hlstd{(lop[[}\hlstr{"a"}\hlstd{]]} \hlopt{*} \hlstd{HL}\hlopt{$}\hlstd{LngtClass[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{lops]}\hlopt{^}\hlstd{lop[[}\hlstr{"b"}\hlstd{]])}\hlopt{/}\hlnum{1000}

\hlstd{HL}\hlopt{$}\hlstd{WtLength[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlkwd{c}\hlstd{(gads, flats)]} \hlkwb{<-} \hlkwd{exp}\hlstd{(HL}\hlopt{$}\hlstd{LogWtLength[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlkwd{c}\hlstd{(gads, flats)])}  \hlcom{# convert back to weight in grams}

\hlstd{HL}\hlopt{$}\hlstd{Wt} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{WtLength} \hlopt{*} \hlstd{HL}\hlopt{$}\hlstd{HLNoAtLngt} \hlopt{*} \hlstd{HL}\hlopt{$}\hlstd{SubFactor}  \hlcom{# Total weight in g}
\hlstd{HL}\hlopt{$}\hlstd{Wt} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{Wt}\hlopt{/}\hlnum{1000}  \hlcom{# Weight in Kg}
\hlcom{# bias correct}
\hlstd{HL}\hlopt{$}\hlstd{Wt[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{Wt[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlopt{*}
    \hlstd{corr.fact[[}\hlnum{1}\hlstd{]]}
\hlstd{HL}\hlopt{$}\hlstd{Wt[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlstd{HL}\hlopt{$}\hlstd{Wt[HL}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlopt{*}
    \hlstd{corr.fact[[}\hlnum{2}\hlstd{]]}

\hlcom{## And aggregate across lengths split into Ju and Ad}

\hlcom{## For anglerfish, there is no minimum size but a minimum}
\hlcom{## landing weight of 500g for marketing...let's find the}
\hlcom{## equivalent length from the data}

\hlcom{# Find the length equivalent of the 500 g}
\hlstd{fn_opt} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{a}\hlstd{,} \hlkwc{b}\hlstd{,} \hlkwc{L}\hlstd{) \{}
    \hlstd{res} \hlkwb{<-} \hlstd{(a} \hlopt{*} \hlstd{(L}\hlopt{^}\hlstd{b))}\hlopt{/}\hlnum{1000}
    \hlkwd{return}\hlstd{(res} \hlopt{-} \hlnum{0.5}\hlstd{)}
\hlstd{\}}

\hlcom{# optimise}
\hlkwd{print}\hlstd{(}\hlkwd{uniroot}\hlstd{(}\hlkwc{f} \hlstd{= fn_opt,} \hlkwc{a} \hlstd{= lop[[}\hlstr{"a"}\hlstd{]],} \hlkwc{b} \hlstd{= lop[[}\hlstr{"b"}\hlstd{]],} \hlkwc{interval} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}
    \hlnum{150}\hlstd{)))}
\end{alltt}
\begin{verbatim}
## $root
## [1] 32.35575
## 
## $f.root
## [1] 1.712325e-07
## 
## $iter
## [1] 10
## 
## $init.it
## [1] NA
## 
## $estim.prec
## [1] 6.103516e-05
\end{verbatim}
\begin{alltt}
\hlstd{size} \hlkwb{<-} \hlkwd{uniroot}\hlstd{(}\hlkwc{f} \hlstd{= fn_opt,} \hlkwc{a} \hlstd{= lop[[}\hlstr{"a"}\hlstd{]],} \hlkwc{b} \hlstd{= lop[[}\hlstr{"b"}\hlstd{]],} \hlkwc{interval} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}
    \hlnum{150}\hlstd{))}\hlopt{$}\hlstd{root}
\hlcom{## Anglerfish minimum size is equivalent to 32.35 cm}

\hlstd{lop[[}\hlstr{"a"}\hlstd{]]} \hlopt{*} \hlstd{(size}\hlopt{^}\hlstd{lop[[}\hlstr{"b"}\hlstd{]])}\hlopt{/}\hlnum{1000}
\end{alltt}
\begin{verbatim}
## [1] 0.5000002
\end{verbatim}
\begin{alltt}
\hlstd{lop.df} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{L} \hlstd{=} \hlnum{1}\hlopt{:}\hlnum{150}\hlstd{,} \hlkwc{Wt} \hlstd{= (lop[[}\hlstr{"a"}\hlstd{]]} \hlopt{*} \hlstd{(}\hlkwd{c}\hlstd{(}\hlnum{1}\hlopt{:}\hlnum{150}\hlstd{)}\hlopt{^}\hlstd{lop[[}\hlstr{"b"}\hlstd{]]))}\hlopt{/}\hlnum{1000}\hlstd{)}

\hlkwd{ggplot}\hlstd{(lop.df,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= L,} \hlkwc{y} \hlstd{= Wt))} \hlopt{+} \hlkwd{geom_line}\hlstd{()} \hlopt{+} \hlkwd{geom_segment}\hlstd{(}\hlkwc{data} \hlstd{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{x} \hlstd{= size,}
    \hlkwc{x1} \hlstd{= size,} \hlkwc{y} \hlstd{=} \hlnum{0}\hlstd{,} \hlkwc{y1} \hlstd{=} \hlnum{0.5}\hlstd{),} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= x,} \hlkwc{xend} \hlstd{= x1,} \hlkwc{y} \hlstd{= y,}
    \hlkwc{yend} \hlstd{= y1),} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{geom_segment}\hlstd{(}\hlkwc{data} \hlstd{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{x} \hlstd{=} \hlnum{0}\hlstd{,}
    \hlkwc{x1} \hlstd{= size,} \hlkwc{y} \hlstd{=} \hlnum{0.5}\hlstd{,} \hlkwc{y1} \hlstd{=} \hlnum{0.5}\hlstd{),} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= x,} \hlkwc{xend} \hlstd{= x1,} \hlkwc{y} \hlstd{= y,}
    \hlkwc{yend} \hlstd{= y1),} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Lophius spp. size at minimum
\textbackslash{}t\textbackslash{}t\textbackslash{}t\textbackslash{}t\textbackslash{}t\textbackslash{}t  marketing weight"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/AddingWeights-1} 

}


\begin{kframe}\begin{alltt}
\hlcom{## Assign to length groups}
\hlstd{HL}\hlopt{$}\hlstd{SpeciesName} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Gadus morhua"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<}
    \hlnum{34.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==}
    \hlstr{"Gadus morhua"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{34.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,}
    \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Melanogrammus aeglefinus"} \hlopt{&}
    \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),}
    \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Melanogrammus aeglefinus"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=}
        \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==}
        \hlstr{"Merlangius merlangus"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,}
        \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Merlangius merlangus"} \hlopt{&}
        \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),}
        \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Merluccius merluccius"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<}
            \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==}
            \hlstr{"Merluccius merluccius"} \hlopt{&} \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,}
            \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Pleuronectes platessa"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Pleuronectes platessa"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Solea solea"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{23.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Solea solea"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{23.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lepidorhombus whiffiagonis"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{19.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lepidorhombus whiffiagonis"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{19.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lophius piscatorius"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lophius piscatorius"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lophius budegassa"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{>=} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Adu"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName} \hlopt{==} \hlstr{"Lophius budegassa"} \hlopt{&}
            \hlstd{HL}\hlopt{$}\hlstd{LngtClass} \hlopt{<} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"Juv"}\hlstd{,}
            \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{paste}\hlstd{(HL}\hlopt{$}\hlstd{SpeciesName,} \hlstr{"All"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{)))))))))))))))))))}

\hlstd{DF} \hlkwb{<-} \hlstd{HL[}\hlopt{!}\hlkwd{is.na}\hlstd{(HL}\hlopt{$}\hlstd{Wt), ]}
\hlstd{DF} \hlkwb{<-} \hlstd{DF} \hlopt{%>%} \hlkwd{group_by}\hlstd{(Survey, Quarter, Country, Ship, Gear, StNo,}
    \hlstd{HaulNo, Year, SpeciesName)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{Kg} \hlstd{=} \hlkwd{sum}\hlstd{(Wt))} \hlopt{%>%}
    \hlkwd{as.data.frame}\hlstd{()}

\hlcom{# Now merge in the station details: lat, lon etc..  midpoint}
\hlcom{# of haul locations - small enough distances to not worry}
\hlcom{# about spherical distances}
\hlstd{HH}\hlopt{$}\hlstd{HaulLatMid} \hlkwb{<-} \hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLat)} \hlopt{+} \hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLat))}\hlopt{/}\hlnum{2}
\hlstd{HH}\hlopt{$}\hlstd{HaulLonMid} \hlkwb{<-} \hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLon)} \hlopt{+} \hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLon))}\hlopt{/}\hlnum{2}

\hlcom{# Fix blank spaces in variables...}
\hlstd{DF}\hlopt{$}\hlstd{Survey} \hlkwb{<-} \hlkwd{gsub}\hlstd{(}\hlstr{" "}\hlstd{,} \hlstr{""}\hlstd{, DF}\hlopt{$}\hlstd{Survey)}
\hlstd{DF}\hlopt{$}\hlstd{Gear} \hlkwb{<-} \hlkwd{gsub}\hlstd{(}\hlstr{" "}\hlstd{,} \hlstr{""}\hlstd{, DF}\hlopt{$}\hlstd{Gear)}
\hlstd{DF}\hlopt{$}\hlstd{Ship} \hlkwb{<-} \hlkwd{gsub}\hlstd{(}\hlstr{" "}\hlstd{,} \hlstr{""}\hlstd{, DF}\hlopt{$}\hlstd{Ship)}
\hlstd{DF}\hlopt{$}\hlstd{StNo} \hlkwb{<-} \hlkwd{gsub}\hlstd{(}\hlstr{" "}\hlstd{,} \hlstr{""}\hlstd{, DF}\hlopt{$}\hlstd{StNo)}

\hlcom{## Create a haul record for each species}
\hlstd{HH} \hlkwb{<-} \hlkwd{merge}\hlstd{(}\hlkwc{x} \hlstd{= HH,} \hlkwc{y} \hlstd{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{SpeciesName} \hlstd{=} \hlkwd{unique}\hlstd{(DF}\hlopt{$}\hlstd{SpeciesName)))}

\hlcom{# Join on the catch data}
\hlstd{DF2} \hlkwb{<-} \hlkwd{full_join}\hlstd{(}\hlkwc{x} \hlstd{= HH,} \hlkwc{y} \hlstd{= DF)}
\hlstd{DF2}\hlopt{$}\hlstd{Kg[}\hlkwd{is.na}\hlstd{(DF2}\hlopt{$}\hlstd{Kg)]} \hlkwb{<-} \hlnum{0}  \hlcom{#NAs are zero catches of the species}

\hlcom{# Subset to variables of interest}
\hlstd{DF} \hlkwb{<-} \hlstd{DF2[}\hlkwd{c}\hlstd{(}\hlstr{"Survey"}\hlstd{,} \hlstr{"Ship"}\hlstd{,} \hlstr{"StNo"}\hlstd{,} \hlstr{"HaulNo"}\hlstd{,} \hlstr{"Year"}\hlstd{,} \hlstr{"Month"}\hlstd{,}
    \hlstr{"SpeciesName"}\hlstd{,} \hlstr{"HaulLatMid"}\hlstd{,} \hlstr{"HaulLonMid"}\hlstd{,} \hlstr{"HaulDur"}\hlstd{,} \hlstr{"SweptArea"}\hlstd{,}
    \hlstr{"SweptAreaAdj"}\hlstd{,} \hlstr{"Kg"}\hlstd{)]}

\hlcom{# Remove marginal areas}
\hlstd{DF} \hlkwb{<-} \hlkwd{filter}\hlstd{(DF, HaulLonMid} \hlopt{< -}\hlnum{2} \hlopt{&} \hlstd{HaulLonMid} \hlopt{> -}\hlnum{12}\hlstd{)}
\hlstd{DF} \hlkwb{<-} \hlkwd{filter}\hlstd{(DF, HaulLatMid} \hlopt{>} \hlnum{48} \hlopt{&} \hlstd{HaulLatMid} \hlopt{<} \hlnum{52}\hlstd{)}

\hlcom{# Save}
\hlkwd{save}\hlstd{(DF,} \hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlstr{"Cleaned"}\hlstd{,} \hlstr{"CelticSurveyFormattedSize.RData"}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{Cefas survey data}

The same process was undergone for the Cefas survey data. The only differences
were:

\begin{itemize}
	\item 12 040 tows were recorded as valid, with 677 either recorded
		invalid, abnormal or otherwise classified as irregular.
	\item Due to some abnormally large tow distances, a standardised tow
		distance (per 60 m ) was calculated, and a Median Absolute
		Deviation (MAD) per survey series, with only standardised tow
		distances +- 5 times the value kept. This removed 578 outlier
		tows (keeping 9022).
	\item Swept Area sometimes reflected the use of a single or double beam
		trawl.
	\item The correction factor used was either an otter trawl value of
		0.38 (as above) or a beam trawl value of 0.19, as appropriate.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{FSS} \hlkwb{<-} \hlkwd{read.csv}\hlstd{(}\hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlstr{"CEFAS"}\hlstd{,} \hlstr{"WesternSurveys_V20160905.dat"}\hlstd{))}

\hlcom{###################################### Process station data}
\hlstd{Stations} \hlkwb{<-} \hlkwd{group_by}\hlstd{(FSS, fldSeriesName, fldCruiseName, fldGearDescription,}
    \hlstd{Year, Month, Day, Time, fldCruiseStationNumber, fldValidityCode,}
    \hlstd{fldTowDuration)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{ShootLat} \hlstd{=} \hlkwd{mean}\hlstd{(fldShotLatDecimalDegrees),}
    \hlkwc{ShootLon} \hlstd{=} \hlkwd{mean}\hlstd{(fldShotLonDecimalDegrees),} \hlkwc{HaulLat} \hlstd{=} \hlkwd{mean}\hlstd{(fldHaulLatDecimalDegrees),}
    \hlkwc{HaulLon} \hlstd{=} \hlkwd{mean}\hlstd{(fldHaulLonDecimalDegrees))} \hlopt{%>%} \hlkwd{as.data.frame}\hlstd{()}
\hlcom{###################################### }

\hlcom{# Keep only valid hauls}
\hlkwd{table}\hlstd{(Stations}\hlopt{$}\hlstd{fldValidityCode)}
\hlstd{Stations} \hlkwb{<-} \hlkwd{filter}\hlstd{(Stations, fldValidityCode} \hlopt{==} \hlstr{"V"}\hlstd{)}

\hlcom{################################################################## There are some tows which are clearly too large a}
\hlcom{################################################################## distance...  so to clean the data but note tow distance}
\hlcom{################################################################## varies greatly over time - so standardise}

\hlcom{############################ 3}
\hlstd{Stations}\hlopt{$}\hlstd{Dist} \hlkwb{<-} \hlkwd{mapply}\hlstd{(gcd.hf,} \hlkwc{long1} \hlstd{=} \hlkwd{deg2rad}\hlstd{(Stations}\hlopt{$}\hlstd{ShootLon),}
    \hlkwc{lat1} \hlstd{=} \hlkwd{deg2rad}\hlstd{(Stations}\hlopt{$}\hlstd{ShootLat),} \hlkwc{long2} \hlstd{=} \hlkwd{deg2rad}\hlstd{(Stations}\hlopt{$}\hlstd{HaulLon),}
    \hlkwc{lat2} \hlstd{=} \hlkwd{deg2rad}\hlstd{(Stations}\hlopt{$}\hlstd{HaulLat))}

\hlkwd{summary}\hlstd{(Stations}\hlopt{$}\hlstd{Dist)}

\hlstd{Stations}\hlopt{$}\hlstd{DistStand} \hlkwb{<-} \hlstd{(Stations}\hlopt{$}\hlstd{Dist}\hlopt{/}\hlstd{Stations}\hlopt{$}\hlstd{fldTowDuration)} \hlopt{*}
    \hlnum{60}

\hlcom{# Remove any over or under the SE of median distance for the}
\hlcom{# survey (robust detection of outliers}
\hlcom{# https://www.r-bloggers.com/absolute-deviation-around-the-median/)}

\hlstd{StationsClean} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Stations, fldSeriesName)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{median} \hlstd{=} \hlkwd{median}\hlstd{(DistStand),}
    \hlkwc{mean} \hlstd{=} \hlkwd{mean}\hlstd{(DistStand),} \hlkwc{MAD} \hlstd{=} \hlkwd{mad}\hlstd{(DistStand,} \hlkwc{center} \hlstd{=} \hlkwd{median}\hlstd{(DistStand)))} \hlopt{%>%}
    \hlkwd{as.data.frame}\hlstd{()}

\hlstd{StationsClean}\hlopt{$}\hlstd{Up} \hlkwb{<-} \hlstd{StationsClean}\hlopt{$}\hlstd{median} \hlopt{+} \hlnum{5} \hlopt{*} \hlstd{StationsClean}\hlopt{$}\hlstd{MAD}
\hlstd{StationsClean}\hlopt{$}\hlstd{Lo} \hlkwb{<-} \hlstd{StationsClean}\hlopt{$}\hlstd{median} \hlopt{-} \hlnum{5} \hlopt{*} \hlstd{StationsClean}\hlopt{$}\hlstd{MAD}

\hlcom{## Now add the upper and lower thresholds to the stations}
\hlstd{Stations}\hlopt{$}\hlstd{LoThres} \hlkwb{<-} \hlstd{StationsClean}\hlopt{$}\hlstd{Lo[}\hlkwd{match}\hlstd{(Stations}\hlopt{$}\hlstd{fldSeriesName,}
    \hlstd{StationsClean}\hlopt{$}\hlstd{fldSeriesName)]}
\hlstd{Stations}\hlopt{$}\hlstd{UpThres} \hlkwb{<-} \hlstd{StationsClean}\hlopt{$}\hlstd{Up[}\hlkwd{match}\hlstd{(Stations}\hlopt{$}\hlstd{fldSeriesName,}
    \hlstd{StationsClean}\hlopt{$}\hlstd{fldSeriesName)]}

\hlstd{Stations}\hlopt{$}\hlstd{InTol} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{DistStand} \hlopt{>=} \hlstd{Stations}\hlopt{$}\hlstd{LoThres} \hlopt{&}
    \hlstd{Stations}\hlopt{$}\hlstd{DistStand} \hlopt{<=} \hlstd{Stations}\hlopt{$}\hlstd{UpThres,} \hlstr{"KEEP"}\hlstd{,} \hlstr{"LOSE"}\hlstd{)}

\hlkwd{table}\hlstd{(Stations}\hlopt{$}\hlstd{InTol)}

\hlcom{######################################################################## midpoint of haul locations - small enough distances to not}
\hlcom{######################################################################## worry about spherical distances}
\hlstd{an} \hlkwb{<-} \hlstd{as.numeric}
\hlstd{Stations}\hlopt{$}\hlstd{HaulLatMid} \hlkwb{<-} \hlstd{(}\hlkwd{an}\hlstd{(Stations}\hlopt{$}\hlstd{ShootLat)} \hlopt{+} \hlkwd{an}\hlstd{(Stations}\hlopt{$}\hlstd{HaulLat))}\hlopt{/}\hlnum{2}
\hlstd{Stations}\hlopt{$}\hlstd{HaulLonMid} \hlkwb{<-} \hlstd{(}\hlkwd{an}\hlstd{(Stations}\hlopt{$}\hlstd{ShootLon)} \hlopt{+} \hlkwd{an}\hlstd{(Stations}\hlopt{$}\hlstd{HaulLon))}\hlopt{/}\hlnum{2}

\hlcom{## Calculate the swept area per gear for beam trawls its easy,}
\hlcom{## for otter trawls need to include the doorspread for}
\hlcom{## effective swept area}

\hlstd{Surveys} \hlkwb{<-} \hlkwd{sort}\hlstd{(}\hlkwd{unique}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription))}

\hlstd{Surveys} \hlkwb{<-} \hlstd{Surveys[}\hlkwd{c}\hlstd{(}\hlnum{1}\hlopt{:}\hlnum{9}\hlstd{,} \hlnum{23}\hlstd{,} \hlnum{31}\hlopt{:}\hlnum{46}\hlstd{,} \hlnum{48}\hlstd{,} \hlnum{49}\hlstd{)]}
\hlcom{# Only keep the trawl fish surveys}
\hlkwd{print}\hlstd{(Surveys)}
\hlstd{Stations} \hlkwb{<-} \hlkwd{filter}\hlstd{(Stations, fldGearDescription} \hlopt{%in%} \hlstd{Surveys)}

\hlcom{## No details for otter trawl deployment, so use the standard}
\hlcom{## 87m doorspread}
\hlstd{Stations}\hlopt{$}\hlstd{GearWidth} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%}
    \hlstd{Surveys[}\hlnum{1}\hlstd{],} \hlnum{2}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%} \hlstd{Surveys[}\hlnum{2}\hlopt{:}\hlnum{5}\hlstd{],}
    \hlnum{3}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%} \hlstd{Surveys[}\hlnum{6}\hlopt{:}\hlnum{9}\hlstd{],}
        \hlnum{4}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%} \hlstd{Surveys[}\hlnum{10}\hlstd{],}
            \hlnum{87}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%} \hlstd{Surveys[}\hlnum{11}\hlopt{:}\hlnum{12}\hlstd{],}
                \hlnum{4}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%} \hlstd{Surveys[}\hlnum{13}\hlopt{:}\hlnum{25}\hlstd{],}
                  \hlnum{87}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%}
                    \hlstd{Surveys[}\hlnum{26}\hlopt{:}\hlnum{27}\hlstd{],} \hlnum{4}\hlstd{,} \hlkwd{ifelse}\hlstd{(Stations}\hlopt{$}\hlstd{fldGearDescription} \hlopt{%in%}
                    \hlstd{Surveys[}\hlnum{28}\hlstd{],} \hlnum{87}\hlstd{,} \hlnum{NA}\hlstd{))))))))}

\hlstd{Stations}\hlopt{$}\hlstd{SweptArea} \hlkwb{<-} \hlstd{Stations}\hlopt{$}\hlstd{Dist} \hlopt{*} \hlstd{(Stations}\hlopt{$}\hlstd{GearWidth}\hlopt{/}\hlnum{1000}\hlstd{)}

\hlcom{## Adjust swept area for gear efficiencies, after Piet et al}
\hlcom{## for roundfish:}

\hlcom{# BT: 0.19 OT: 0.22 - 0.54 (Juv, ad). 0.38}

\hlstd{Stations} \hlkwb{<-} \hlstd{Stations[}\hlopt{!}\hlkwd{is.na}\hlstd{(Stations}\hlopt{$}\hlstd{GearWidth), ]}

\hlstd{Stations}\hlopt{$}\hlstd{SweptAreaAdjFac} \hlkwb{<-} \hlkwd{sapply}\hlstd{(Stations}\hlopt{$}\hlstd{GearWidth,} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{) \{}
    \hlkwa{if} \hlstd{(x} \hlopt{%in%} \hlkwd{c}\hlstd{(}\hlnum{2.5}\hlstd{,} \hlnum{3}\hlstd{,} \hlnum{4}\hlstd{))}
        \hlkwd{return}\hlstd{(}\hlnum{0.19}\hlstd{)}
    \hlkwa{if} \hlstd{(x} \hlopt{==} \hlnum{87}\hlstd{)}
        \hlkwd{return}\hlstd{(}\hlnum{0.38}\hlstd{)} \hlkwa{else} \hlkwd{return}\hlstd{(}\hlnum{NA}\hlstd{)}
\hlstd{\})}

\hlstd{Stations}\hlopt{$}\hlstd{SweptAreaAdj} \hlkwb{<-} \hlstd{Stations}\hlopt{$}\hlstd{SweptArea} \hlopt{*} \hlstd{Stations}\hlopt{$}\hlstd{SweptAreaAdjFac}

\hlcom{# Only keep stations in tolerance}
\hlstd{Stations} \hlkwb{<-} \hlkwd{filter}\hlstd{(Stations, InTol} \hlopt{==} \hlstr{"KEEP"}\hlstd{)}

\hlkwd{by}\hlstd{(}\hlkwc{data} \hlstd{= Stations}\hlopt{$}\hlstd{SweptAreaAdj,} \hlkwc{INDICES} \hlstd{= Stations}\hlopt{$}\hlstd{fldSeriesName,}
    \hlkwc{FUN} \hlstd{= mean,} \hlkwc{na.rm} \hlstd{= T)}

\hlcom{############################### Process the catches ####}

\hlcom{# Convert all lengths to cm and round to 5cm size class}
\hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlkwb{<-} \hlstd{(FSS}\hlopt{$}\hlstd{fldLengthGroup}\hlopt{/}\hlnum{10}\hlstd{)} \hlopt{+} \hlnum{0.5}

\hlcom{# load a/b parameters Add a and b parameters for}
\hlcom{# length-weight Load the modelled length weight}
\hlcom{# relationships....}
\hlkwd{load}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlstr{"DATRAS"}\hlstd{,} \hlstr{"LengthWeightPredictCelticSea.RData"}\hlstd{))}

\hlcom{# Only species of interest}
\hlstd{FSS} \hlkwb{<-} \hlkwd{filter}\hlstd{(FSS, fldScientificName} \hlopt{%in%} \hlkwd{toupper}\hlstd{(spp))}  \hlcom{# species list from above}

\hlcom{# Add log length}
\hlstd{FSS}\hlopt{$}\hlstd{lL} \hlkwb{<-} \hlkwd{log}\hlstd{(FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{*} \hlnum{10}\hlstd{)}

\hlcom{# Scientific names to small case except first letter}
\hlstd{FSS}\hlopt{$}\hlstd{Species} \hlkwb{<-} \hlkwd{paste}\hlstd{(}\hlkwd{toupper}\hlstd{(}\hlkwd{substring}\hlstd{(FSS}\hlopt{$}\hlstd{fldScientificName,}
    \hlnum{1}\hlstd{,} \hlnum{1}\hlstd{)),} \hlkwd{tolower}\hlstd{(}\hlkwd{substring}\hlstd{(FSS}\hlopt{$}\hlstd{fldScientificName,} \hlnum{2}\hlstd{,} \hlnum{1000}\hlstd{)),}
    \hlkwc{sep} \hlstd{=} \hlstr{""}\hlstd{)}

\hlcom{# Predict log weight gads}
\hlstd{FSS}\hlopt{$}\hlstd{LogWtLength[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2[[}\hlnum{1}\hlstd{]],} \hlkwc{newdata} \hlstd{= FSS[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{gads, ])}
\hlcom{# flats}
\hlstd{FSS}\hlopt{$}\hlstd{LogWtLength[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlkwd{predict}\hlstd{(lm2[[}\hlnum{2}\hlstd{]],}
    \hlkwc{newdata} \hlstd{= FSS[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats, ])}
\hlcom{# anglers}
\hlstd{FSS}\hlopt{$}\hlstd{WtLength} \hlkwb{<-} \hlnum{NA}
\hlstd{FSS}\hlopt{$}\hlstd{WtLength[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]} \hlkwb{<-} \hlstd{(lop[[}\hlstr{"a"}\hlstd{]]} \hlopt{*} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlstd{lops]}\hlopt{^}\hlstd{lop[[}\hlstr{"b"}\hlstd{]])}\hlopt{/}\hlnum{1000}

\hlstd{FSS}\hlopt{$}\hlstd{WtLength[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlkwd{c}\hlstd{(gads, flats)]} \hlkwb{<-} \hlkwd{exp}\hlstd{(FSS}\hlopt{$}\hlstd{LogWtLength[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%}
    \hlkwd{c}\hlstd{(gads, flats)])}  \hlcom{# convert back to weight in grams}

\hlstd{FSS}\hlopt{$}\hlstd{Wt} \hlkwb{<-} \hlstd{FSS}\hlopt{$}\hlstd{WtLength} \hlopt{*} \hlstd{FSS}\hlopt{$}\hlstd{Numbers}  \hlcom{# Total weight in g}
\hlstd{FSS}\hlopt{$}\hlstd{Wt} \hlkwb{<-} \hlstd{FSS}\hlopt{$}\hlstd{Wt}\hlopt{/}\hlnum{1000}  \hlcom{# Weight in Kg}

\hlcom{# bias correct}
\hlstd{FSS}\hlopt{$}\hlstd{Wt[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlkwb{<-} \hlstd{FSS}\hlopt{$}\hlstd{Wt[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]} \hlopt{*}
    \hlstd{corr.fact[[}\hlnum{1}\hlstd{]]}
\hlstd{FSS}\hlopt{$}\hlstd{Wt[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlstd{FSS}\hlopt{$}\hlstd{Wt[FSS}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlopt{*}
    \hlstd{corr.fact[[}\hlnum{2}\hlstd{]]}

\hlstd{FSS} \hlkwb{<-} \hlstd{FSS[}\hlopt{!}\hlkwd{is.na}\hlstd{(FSS}\hlopt{$}\hlstd{Wt), ]}  \hlcom{## Lack length measurements}

\hlcom{# Aggregate split into Ju and Ad}

\hlstd{FSS}\hlopt{$}\hlstd{Species} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Gadus morhua"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<}
    \hlnum{34.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==}
    \hlstr{"Gadus morhua"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{34.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,}
    \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Melanogrammus aeglefinus"} \hlopt{&}
    \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),}
    \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Melanogrammus aeglefinus"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=}
        \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==}
        \hlstr{"Merlangius merlangus"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,}
        \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Merlangius merlangus"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Merluccius merluccius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Merluccius merluccius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Pleuronectes platessa"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Pleuronectes platessa"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{26.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Pollachius pollachius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Pollachius pollachius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{29.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Solea solea"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<}
        \hlnum{23.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==}
        \hlstr{"Solea solea"} \hlopt{&} \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{23.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,}
        \hlstr{"Adu"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lepidorhombus whiffiagonis"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{19.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lepidorhombus whiffiagonis"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{19.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lophius piscatorius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lophius piscatorius"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lophius budegassa"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{>=} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Adu"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{ifelse}\hlstd{(FSS}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstr{"Lophius budegassa"} \hlopt{&}
        \hlstd{FSS}\hlopt{$}\hlstd{fldLengthGroup} \hlopt{<} \hlnum{32.5}\hlstd{,} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"Juv"}\hlstd{,}
        \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{),} \hlkwd{paste}\hlstd{(FSS}\hlopt{$}\hlstd{Species,} \hlstr{"All"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{"_"}\hlstd{)))))))))))))))))))))}

\hlcom{# Summarise as weight}
\hlstd{FSS} \hlkwb{<-} \hlkwd{group_by}\hlstd{(FSS, fldSeriesName, fldGearDescription, Year,}
    \hlstd{Month, fldCruiseStationNumber, Species)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{Kg} \hlstd{=} \hlkwd{sum}\hlstd{(Wt))} \hlopt{%>%}
    \hlkwd{as.data.frame}\hlstd{()}

\hlcom{## Some stations have multiple gear deployments, we want to}
\hlcom{## have one location per station - to do so, sum the tow}
\hlcom{## durations and swept area so we get an accurate swept area}

\hlstd{Stations} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Stations, fldSeriesName, Year, Month, Day,}
    \hlstd{Time, fldCruiseStationNumber, fldValidityCode, ShootLat,}
    \hlstd{ShootLon, HaulLat, HaulLon, HaulLatMid, HaulLonMid)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{fldTowDuration} \hlstd{=} \hlkwd{mean}\hlstd{(fldTowDuration),}
    \hlkwc{Dist} \hlstd{=} \hlkwd{sum}\hlstd{(Dist),} \hlkwc{DistStand} \hlstd{=} \hlkwd{sum}\hlstd{(DistStand),} \hlkwc{SweptArea} \hlstd{=} \hlkwd{sum}\hlstd{(SweptArea),}
    \hlkwc{SweptAreaAdj} \hlstd{=} \hlkwd{sum}\hlstd{(SweptAreaAdj))} \hlopt{%>%} \hlkwd{as.data.frame}\hlstd{()}

\hlcom{## Also need to sum the biological data}
\hlstd{FSS} \hlkwb{<-} \hlkwd{group_by}\hlstd{(FSS, fldSeriesName, Year, Month, fldCruiseStationNumber,}
    \hlstd{Species)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{Kg} \hlstd{=} \hlkwd{sum}\hlstd{(Kg))} \hlopt{%>%} \hlkwd{as.data.frame}\hlstd{()}

\hlcom{## Now match the positional and catch data}
\hlstd{Stations} \hlkwb{<-} \hlkwd{merge}\hlstd{(}\hlkwc{x} \hlstd{= Stations,} \hlkwc{y} \hlstd{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{Species} \hlstd{=} \hlkwd{unique}\hlstd{(FSS}\hlopt{$}\hlstd{Species)))}

\hlstd{FSS} \hlkwb{<-} \hlstd{FSS[}\hlkwd{c}\hlstd{(}\hlstr{"fldSeriesName"}\hlstd{,} \hlstr{"Year"}\hlstd{,} \hlstr{"Month"}\hlstd{,} \hlstr{"fldCruiseStationNumber"}\hlstd{,}
    \hlstr{"Species"}\hlstd{,} \hlstr{"Kg"}\hlstd{)]}

\hlstd{FSS} \hlkwb{<-} \hlkwd{full_join}\hlstd{(}\hlkwc{x} \hlstd{= Stations,} \hlkwc{y} \hlstd{= FSS)}
\hlcom{# Add zeros}
\hlstd{FSS}\hlopt{$}\hlstd{Kg[}\hlkwd{is.na}\hlstd{(FSS}\hlopt{$}\hlstd{Kg)]} \hlkwb{<-} \hlnum{0}

\hlkwd{by}\hlstd{(FSS}\hlopt{$}\hlstd{Kg,} \hlkwc{INDICES} \hlstd{= FSS}\hlopt{$}\hlstd{Species, summary)}

\hlstd{FSS} \hlkwb{<-} \hlstd{FSS[}\hlkwd{c}\hlstd{(}\hlstr{"fldSeriesName"}\hlstd{,} \hlstr{"Year"}\hlstd{,} \hlstr{"Month"}\hlstd{,} \hlstr{"fldCruiseStationNumber"}\hlstd{,}
    \hlstr{"HaulLatMid"}\hlstd{,} \hlstr{"HaulLonMid"}\hlstd{,} \hlstr{"fldTowDuration"}\hlstd{,} \hlstr{"SweptArea"}\hlstd{,}
    \hlstr{"SweptAreaAdj"}\hlstd{,} \hlstr{"Species"}\hlstd{,} \hlstr{"Kg"}\hlstd{)]}

\hlcom{## Trim to only keep data within core Celtic Sea}
\hlstd{FSS} \hlkwb{<-} \hlkwd{filter}\hlstd{(FSS, HaulLonMid} \hlopt{> -}\hlnum{12} \hlopt{&} \hlstd{HaulLonMid} \hlopt{< -}\hlnum{2}\hlstd{)}  \hlcom{# remove extreme Lons}
\hlstd{FSS} \hlkwb{<-} \hlkwd{filter}\hlstd{(FSS, HaulLatMid} \hlopt{>} \hlnum{48} \hlopt{&} \hlstd{HaulLatMid} \hlopt{<} \hlnum{52}\hlstd{)}  \hlcom{# remove extreme Lats}

\hlcom{# plot(FSS$SweptAreaAdj ~ FSS$fldSeriesName)}
\hlcom{# boxplot(FSS$SweptAreaAdj ~ FSS$Year)}

\hlkwd{table}\hlstd{(FSS}\hlopt{$}\hlstd{Month, FSS}\hlopt{$}\hlstd{Year, FSS}\hlopt{$}\hlstd{fldSeriesName)}

\hlkwd{save}\hlstd{(FSS,} \hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlkwd{getwd}\hlstd{(),} \hlstr{"Cleaned"}\hlstd{,} \hlstr{"CelticSurvey2FormattedSize.RData"}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Exploratory plots}

The following section details some exploratory plots from the cleaned data.
This guides the final dataset used to fit the VAST model.


\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{################################################## }

\hlcom{# Load in data}
\hlkwd{load}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlkwd{getwd}\hlstd{(),} \hlstr{"Cleaned"}\hlstd{,} \hlstr{"CelticSurveyFormattedSize.RData"}\hlstd{))}  \hlcom{# Datras data by weight}
\hlkwd{load}\hlstd{(}\hlkwd{file.path}\hlstd{(}\hlkwd{getwd}\hlstd{(),} \hlstr{"Cleaned"}\hlstd{,} \hlstr{"CelticSurvey2FormattedSize.RData"}\hlstd{))}  \hlcom{# Cefas data by weight}

\hlstd{DWt} \hlkwb{<-} \hlstd{DF}
\hlstd{CWt} \hlkwb{<-} \hlstd{FSS}
\hlkwd{rm}\hlstd{(DF, FSS)}  \hlcom{# Rename to avoid confusion}

\hlcom{################################################## Combine the datasets}
\hlstd{Wt} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{Survey} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{Survey,} \hlkwd{as.character}\hlstd{(CWt}\hlopt{$}\hlstd{fldSeriesName)),}
    \hlkwc{Year} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{Year, CWt}\hlopt{$}\hlstd{Year),} \hlkwc{Month} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{Month, CWt}\hlopt{$}\hlstd{Month),}
    \hlkwc{HaulNo} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{HaulNo, CWt}\hlopt{$}\hlstd{fldCruiseStationNumber),} \hlkwc{Lon} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{HaulLonMid,}
        \hlstd{CWt}\hlopt{$}\hlstd{HaulLonMid),} \hlkwc{Lat} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{HaulLatMid, CWt}\hlopt{$}\hlstd{HaulLatMid),}
    \hlkwc{HaulDur} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{HaulDur, CWt}\hlopt{$}\hlstd{fldTowDuration),} \hlkwc{SweptArea} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{SweptAreaAdj,}
        \hlstd{CWt}\hlopt{$}\hlstd{SweptAreaAdj),} \hlkwc{Species} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{Species, CWt}\hlopt{$}\hlstd{Species),}
    \hlkwc{Kg} \hlstd{=} \hlkwd{c}\hlstd{(DWt}\hlopt{$}\hlstd{Kg, CWt}\hlopt{$}\hlstd{Kg))}
\hlkwd{rm}\hlstd{(DWt, CWt)}
\end{alltt}
\end{kframe}
\end{knitrout}

\subsection{Survey locations}

The following figure shows the surveys locations each year, with each survey
coloured differently.\\

As can be seen, initially (1982 - 1985) survey coverage was sparse and
irregular, only covered by the Cefas WCGFS. From 1986 this survey becomes more
regular and established, but is discontinued in 2003. The NWGFS beam trawl
survey was added in 1988 and the CARLHELMAR beam trawl survey covered the
western channel from 1989 until 2013.\\

The next significant change is the addition of the EVHOE survey in 1997,
followed by the IE-IGFS survey and the Q1SWIBTS in 2003 (with the latter
discontinuing in 2010). Finally, the Q1SWBEAM is added around 2006. \\

It is worth noting that the ICES cod and whiting assessments use a truncated
survey series from the WCGFS, only using 1992 - 2004 due to changes in survey
area and concerns about its impact on selectivity. \\

\begin{landscape}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{Stations} \hlkwb{<-} \hlstd{Wt[}\hlopt{!}\hlkwd{duplicated}\hlstd{(}\hlkwd{paste}\hlstd{(Wt}\hlopt{$}\hlstd{Survey, Wt}\hlopt{$}\hlstd{Year, Wt}\hlopt{$}\hlstd{Lon,}
    \hlstd{Wt}\hlopt{$}\hlstd{Lat)), ]}

\hlstd{yrs} \hlkwb{<-} \hlkwd{sort}\hlstd{(}\hlkwd{unique}\hlstd{(Stations}\hlopt{$}\hlstd{Year))}
\hlstd{n.yrs} \hlkwb{<-} \hlkwd{length}\hlstd{(yrs)}

\hlstd{map} \hlkwb{<-} \hlkwd{map_data}\hlstd{(}\hlstr{"world"}\hlstd{,} \hlkwc{region} \hlstd{=} \hlkwd{c}\hlstd{(}\hlstr{"UK"}\hlstd{,} \hlstr{"Ireland"}\hlstd{,} \hlstr{"France"}\hlstd{))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{()} \hlopt{+} \hlkwd{geom_polygon}\hlstd{(}\hlkwc{data} \hlstd{= map,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= long,} \hlkwc{y} \hlstd{= lat,}
    \hlkwc{group} \hlstd{= group),} \hlkwc{colour} \hlstd{=} \hlstr{"black"}\hlstd{,} \hlkwc{fill} \hlstd{=} \hlstr{"grey"}\hlstd{)} \hlopt{+} \hlkwd{coord_fixed}\hlstd{(}\hlkwc{xlim} \hlstd{=} \hlkwd{c}\hlstd{(}\hlopt{-}\hlnum{12}\hlstd{,}
    \hlnum{2}\hlstd{),} \hlkwc{ylim} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{48}\hlstd{,} \hlnum{52}\hlstd{),} \hlkwc{ratio} \hlstd{=} \hlnum{1.3}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwc{data} \hlstd{= Stations,}
    \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Lon,} \hlkwc{y} \hlstd{= Lat,} \hlkwc{colour} \hlstd{= Survey),} \hlkwc{shape} \hlstd{=} \hlstr{"+"}\hlstd{)} \hlopt{+} \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Year,}
    \hlkwc{ncol} \hlstd{=} \hlnum{5}\hlstd{)} \hlopt{+} \hlkwd{theme_classic}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Survey locations by year and survey"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=1\linewidth]{figure/Survey_locations-1} 

\end{knitrout}

\end{landscape}

\subsection{Survey temporal coverage}

The following table and plots detail the temporal coverage of the surveys. As
can be seen, the number of stations was initially low (< 100) but increased to
> 200 by 1997.\\

The majority of survey effort is in the fourth quarter, though some survey
effort is also undertaken in the first quarter

The majority of survey effort is in the fourth quarter, though some survey
effort is also undertaken in the first quarter. \\ 

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{kable}\hlstd{(}\hlkwd{table}\hlstd{(Stations}\hlopt{$}\hlstd{Year, Stations}\hlopt{$}\hlstd{Survey))}
\end{alltt}
\end{kframe}
\begin{tabular}{l|r|r|r|r|r|r|r}
\hline
  & CARLHELMAR & EVHOE & IE-IGFS & NWGFS & Q1SWBEAM & Q4SWIBTS & WCGFS\\
\hline
1982 & 0 & 0 & 0 & 0 & 0 & 0 & 59\\
\hline
1983 & 0 & 0 & 0 & 0 & 0 & 0 & 32\\
\hline
1984 & 0 & 0 & 0 & 0 & 0 & 0 & 52\\
\hline
1985 & 0 & 0 & 0 & 0 & 0 & 0 & 84\\
\hline
1986 & 0 & 0 & 0 & 0 & 0 & 0 & 77\\
\hline
1987 & 0 & 0 & 0 & 0 & 0 & 0 & 88\\
\hline
1988 & 0 & 0 & 0 & 21 & 0 & 0 & 105\\
\hline
1989 & 52 & 0 & 0 & 51 & 0 & 0 & 52\\
\hline
1990 & 54 & 0 & 0 & 20 & 0 & 0 & 52\\
\hline
1991 & 50 & 0 & 0 & 32 & 0 & 0 & 100\\
\hline
1992 & 54 & 0 & 0 & 34 & 0 & 0 & 111\\
\hline
1993 & 55 & 0 & 0 & 105 & 0 & 0 & 55\\
\hline
1994 & 57 & 0 & 0 & 95 & 0 & 0 & 31\\
\hline
1995 & 53 & 0 & 0 & 57 & 0 & 0 & 54\\
\hline
1996 & 57 & 0 & 0 & 81 & 0 & 0 & 53\\
\hline
1997 & 52 & 46 & 0 & 86 & 0 & 0 & 64\\
\hline
1998 & 58 & 55 & 0 & 69 & 0 & 0 & 63\\
\hline
1999 & 56 & 56 & 0 & 40 & 0 & 0 & 64\\
\hline
2000 & 56 & 47 & 0 & 33 & 0 & 0 & 64\\
\hline
2001 & 51 & 76 & 0 & 37 & 0 & 0 & 59\\
\hline
2002 & 70 & 73 & 0 & 43 & 0 & 0 & 62\\
\hline
2003 & 128 & 72 & 49 & 43 & 0 & 35 & 48\\
\hline
2004 & 72 & 62 & 54 & 41 & 0 & 52 & 57\\
\hline
2005 & 59 & 67 & 60 & 41 & 0 & 40 & 0\\
\hline
2006 & 58 & 59 & 71 & 43 & 61 & 18 & 0\\
\hline
2007 & 58 & 70 & 77 & 41 & 64 & 38 & 0\\
\hline
2008 & 53 & 65 & 74 & 36 & 68 & 37 & 0\\
\hline
2009 & 55 & 59 & 64 & 43 & 63 & 32 & 0\\
\hline
2010 & 57 & 59 & 81 & 41 & 81 & 42 & 0\\
\hline
2011 & 57 & 71 & 86 & 40 & 80 & 39 & 0\\
\hline
2012 & 54 & 56 & 85 & 42 & 80 & 0 & 0\\
\hline
2013 & 58 & 63 & 83 & 42 & 127 & 0 & 0\\
\hline
2014 & 0 & 69 & 84 & 43 & 86 & 0 & 0\\
\hline
2015 & 0 & 62 & 68 & 43 & 126 & 0 & 0\\
\hline
2016 & 0 & 0 & 0 & 0 & 132 & 0 & 0\\
\hline
\end{tabular}

\begin{kframe}\begin{alltt}
\hlstd{surveyyrs} \hlkwb{<-} \hlstd{reshape2}\hlopt{::}\hlkwd{melt}\hlstd{(}\hlkwd{table}\hlstd{(Stations}\hlopt{$}\hlstd{Survey, Stations}\hlopt{$}\hlstd{Year))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(surveyyrs[surveyyrs}\hlopt{$}\hlstd{value} \hlopt{!=} \hlnum{0}\hlstd{, ],} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Var2,}
    \hlkwc{y} \hlstd{= Var1))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{size} \hlstd{= value))} \hlopt{+} \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+}
    \hlkwd{theme}\hlstd{(}\hlkwc{legend.title} \hlstd{=} \hlkwd{element_blank}\hlstd{())} \hlopt{+} \hlkwd{geom_vline}\hlstd{(}\hlkwc{xintercept} \hlstd{=} \hlnum{1997}\hlstd{)} \hlopt{+}
    \hlkwd{ggtitle}\hlstd{(}\hlstr{"Number of Stations Per Survey Per Year"}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_by_year-1} 

}



\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{surveymo} \hlkwb{<-} \hlstd{reshape2}\hlopt{::}\hlkwd{melt}\hlstd{(}\hlkwd{table}\hlstd{(Stations}\hlopt{$}\hlstd{Month, Stations}\hlopt{$}\hlstd{Year))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(surveymo[surveymo}\hlopt{$}\hlstd{value} \hlopt{!=} \hlnum{0}\hlstd{, ],} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Var2,} \hlkwc{y} \hlstd{= Var1))} \hlopt{+}
    \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{size} \hlstd{= value))} \hlopt{+} \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.title} \hlstd{=} \hlkwd{element_blank}\hlstd{())} \hlopt{+}
    \hlkwd{geom_vline}\hlstd{(}\hlkwc{xintercept} \hlstd{=} \hlnum{1997}\hlstd{)} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Number of Stations Per Survey Per Month"}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_by_month-1} 

}



\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{surveyno} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Stations, Survey, Year)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{n} \hlstd{=} \hlkwd{n}\hlstd{())}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(surveyno,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= n))} \hlopt{+} \hlkwd{geom_bar}\hlstd{(}\hlkwc{stat} \hlstd{=} \hlstr{"identity"}\hlstd{,}
    \hlkwd{aes}\hlstd{(}\hlkwc{fill} \hlstd{= Survey),} \hlkwc{colour} \hlstd{=} \hlstr{"black"}\hlstd{)} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))} \hlopt{+}
    \hlkwd{ggtitle}\hlstd{(}\hlstr{"No stations per year, per survey"}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_effort_by_year-1} 

}



\end{knitrout}

The surveys are using different gears. The main difference being that the
WCGFS, IE-IGFS, EVHOE and WCGFS use otter trawl gears, while the CARLHELMAR,
NWGFS, Q1SWBEAM use beam trawl gears. The WCGFS initially used hour long tows,
but changes to 30 min tows consistent with other surveys later in the series. \\ 

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{boxplot}\hlstd{(Stations}\hlopt{$}\hlstd{SweptArea} \hlopt{~} \hlstd{Stations}\hlopt{$}\hlstd{Survey,} \hlkwc{xlab} \hlstd{=} \hlstr{"Survey Series"}\hlstd{,}
    \hlkwc{ylab} \hlstd{=} \hlstr{"Swept Area (km2)"}\hlstd{,} \hlkwc{main} \hlstd{=} \hlstr{"Swept Area by Survey"}\hlstd{,}
    \hlkwc{cex.axis} \hlstd{=} \hlnum{0.5}\hlstd{)}
\hlkwd{axis}\hlstd{(}\hlnum{2}\hlstd{,} \hlkwc{las} \hlstd{=} \hlnum{1}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_swept_area-1} 

}


\begin{kframe}\begin{alltt}
\hlkwd{boxplot}\hlstd{(}\hlkwd{as.numeric}\hlstd{(}\hlkwd{as.character}\hlstd{(Stations}\hlopt{$}\hlstd{HaulDur))} \hlopt{~} \hlstd{Stations}\hlopt{$}\hlstd{Survey,}
    \hlkwc{xlab} \hlstd{=} \hlstr{"Survey Series"}\hlstd{,} \hlkwc{ylab} \hlstd{=} \hlstr{"Haul Duration (m)"}\hlstd{,} \hlkwc{main} \hlstd{=} \hlstr{"Haul Duration by Survey"}\hlstd{,}
    \hlkwc{cex.axis} \hlstd{=} \hlnum{0.5}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_swept_area-2} 

}



\end{knitrout}

The following plots show the minimum, maximum and mean (red points) survey
latitude and longitude per year, to explore changes in survey coverage. \\

The longitude max and min has broadly been at -2.5 to -12 for the time series,
though has been more consistent since 1990. The addition of the CARLHELMAR
survey in 1988 shifted the mean survey location eastwards, from around -8 to -5
degrees. \\

The latitudinal max and min has also generally been from 48 to 52 degrees over
the time series, though this has been more consistent since 1996. The mean has
generally been around 51 degrees.


\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{Lats_Lons} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Stations, Year)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{minLon} \hlstd{=} \hlkwd{min}\hlstd{(Lon),}
    \hlkwc{maxLon} \hlstd{=} \hlkwd{max}\hlstd{(Lon),} \hlkwc{meanLon} \hlstd{=} \hlkwd{mean}\hlstd{(Lon),} \hlkwc{minLat} \hlstd{=} \hlkwd{min}\hlstd{(Lat),}
    \hlkwc{maxLat} \hlstd{=} \hlkwd{max}\hlstd{(Lat),} \hlkwc{meanLat} \hlstd{=} \hlkwd{mean}\hlstd{(Lat))}
\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(Lats_Lons,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= minLon))} \hlopt{+} \hlkwd{geom_segment}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{xend} \hlstd{= Year,}
    \hlkwc{yend} \hlstd{= maxLon),} \hlkwc{lwd} \hlstd{=} \hlnum{2}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{y} \hlstd{= meanLon),} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+}
    \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))} \hlopt{+} \hlkwd{ylim}\hlstd{(}\hlnum{0}\hlstd{,}
    \hlopt{-}\hlnum{14}\hlstd{)} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Longitudinal survey coverage: min, max and mean"}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_Spatial_extent-1} 

}


\begin{kframe}\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(Lats_Lons,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= minLat))} \hlopt{+} \hlkwd{geom_segment}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{xend} \hlstd{= Year,}
    \hlkwc{yend} \hlstd{= maxLat),} \hlkwc{lwd} \hlstd{=} \hlnum{2}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{y} \hlstd{= meanLat),} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{)} \hlopt{+}
    \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))} \hlopt{+} \hlkwd{ylim}\hlstd{(}\hlnum{47}\hlstd{,}
    \hlnum{53}\hlstd{)} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Latitudinal survey coverage: min, max and mean"}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_Spatial_extent-2} 

}



\end{knitrout}


The following details the total catch by year, by survey. As can be seen, the
IE-IGFS, EVHOE, WCGFS, Q4SWIBTS and Q1SWBEAM catch reasonable quantities of
gadoids, while the CARLHELMAR and NWGFS catch very little. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{tot} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Wt, Survey, Species, Year)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{Kg} \hlstd{=} \hlkwd{sum}\hlstd{(Kg))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(tot,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= Kg))} \hlopt{+} \hlkwd{geom_bar}\hlstd{(}\hlkwc{stat} \hlstd{=} \hlstr{"identity"}\hlstd{,}
    \hlkwd{aes}\hlstd{(}\hlkwc{fill} \hlstd{= Species))} \hlopt{+} \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Survey,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{)} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{legend.position} \hlstd{=} \hlstr{"bottom"}\hlstd{,}
    \hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{)))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/TotalCatch-1} 

}



\end{knitrout}

We need to check on the proportion of zeros in the data (for the delta
model)...


\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{## Proportion of zeros for each species/year}
\hlstd{yrs} \hlkwb{<-} \hlkwd{sort}\hlstd{(}\hlkwd{unique}\hlstd{(Wt}\hlopt{$}\hlstd{Year))}
\hlstd{spp} \hlkwb{<-} \hlkwd{sort}\hlstd{(}\hlkwd{unique}\hlstd{(Wt}\hlopt{$}\hlstd{Species))}

\hlstd{PropZeros} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow} \hlstd{=} \hlkwd{length}\hlstd{(yrs),} \hlkwc{ncol} \hlstd{=} \hlkwd{length}\hlstd{(spp))}

\hlkwa{for} \hlstd{(y} \hlkwa{in} \hlnum{1}\hlopt{:}\hlkwd{length}\hlstd{(yrs)) \{}
    \hlkwa{for} \hlstd{(s} \hlkwa{in} \hlnum{1}\hlopt{:}\hlkwd{length}\hlstd{(spp)) \{}
        \hlstd{tmp} \hlkwb{<-} \hlkwd{filter}\hlstd{(Wt, Year} \hlopt{==} \hlstd{yrs[y], Species} \hlopt{==} \hlstd{spp[s])}
        \hlstd{PropZeros[y, s]} \hlkwb{<-} \hlkwd{nrow}\hlstd{(tmp[tmp}\hlopt{$}\hlstd{Kg} \hlopt{==} \hlnum{0}\hlstd{, ])}\hlopt{/}\hlkwd{length}\hlstd{(tmp}\hlopt{$}\hlstd{Kg)}
    \hlstd{\}}
\hlstd{\}}

\hlstd{PropZeros} \hlkwb{<-} \hlkwd{as.data.frame}\hlstd{(PropZeros)}
\hlkwd{colnames}\hlstd{(PropZeros)} \hlkwb{<-} \hlstd{spp}
\hlstd{PropZeros}\hlopt{$}\hlstd{Year} \hlkwb{<-} \hlstd{yrs}

\hlstd{x} \hlkwb{<-} \hlstd{reshape2}\hlopt{::}\hlkwd{melt}\hlstd{(PropZeros,} \hlkwc{id} \hlstd{=} \hlstr{"Year"}\hlstd{)}
\hlstd{x}\hlopt{$}\hlstd{col} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(x}\hlopt{$}\hlstd{value} \hlopt{==} \hlnum{0} \hlopt{|} \hlstd{x}\hlopt{$}\hlstd{value} \hlopt{==} \hlnum{1}\hlstd{,} \hlstr{"all zeros or none"}\hlstd{,}
    \hlstr{"OK"}\hlstd{)}

\hlkwd{ggplot}\hlstd{(x,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= variable))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{size} \hlstd{= value,}
    \hlkwc{col} \hlstd{=} \hlkwd{factor}\hlstd{(col)))} \hlopt{+} \hlkwd{theme_bw}\hlstd{()} \hlopt{+} \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/ZeroCheck-1} 

}



\end{knitrout}

The next pages detail the spatial catch distribution of the different species,
followed by the catch per unit effort for the different survey series for each
species. 

\begin{landscape}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{spp} \hlkwb{<-} \hlkwd{sort}\hlstd{(}\hlkwd{unique}\hlstd{(Wt}\hlopt{$}\hlstd{Species))}

\hlkwa{for} \hlstd{(s} \hlkwa{in} \hlnum{1}\hlopt{:}\hlkwd{length}\hlstd{(spp)) \{}

    \hlstd{plotDF} \hlkwb{<-} \hlstd{Wt[Wt}\hlopt{$}\hlstd{Species} \hlopt{==} \hlstd{spp[s], ]}

    \hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{()} \hlopt{+} \hlkwd{geom_polygon}\hlstd{(}\hlkwc{data} \hlstd{= map,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= long,} \hlkwc{y} \hlstd{= lat,}
        \hlkwc{group} \hlstd{= group),} \hlkwc{colour} \hlstd{=} \hlstr{"black"}\hlstd{,} \hlkwc{fill} \hlstd{=} \hlstr{"grey"}\hlstd{)} \hlopt{+} \hlkwd{coord_fixed}\hlstd{(}\hlkwc{xlim} \hlstd{=} \hlkwd{c}\hlstd{(}\hlopt{-}\hlnum{12}\hlstd{,}
        \hlnum{2}\hlstd{),} \hlkwc{ylim} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{48}\hlstd{,} \hlnum{52}\hlstd{),} \hlkwc{ratio} \hlstd{=} \hlnum{1.3}\hlstd{)} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwc{data} \hlstd{= plotDF[plotDF}\hlopt{$}\hlstd{Kg} \hlopt{!=}
        \hlnum{0}\hlstd{, ],} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Lon,} \hlkwc{y} \hlstd{= Lat,} \hlkwc{size} \hlstd{=} \hlkwd{sqrt}\hlstd{(Kg)),} \hlkwc{colour} \hlstd{=} \hlstr{"blue"}\hlstd{,}
        \hlkwc{alpha} \hlstd{=} \hlnum{0.5}\hlstd{)} \hlopt{+} \hlkwd{scale_size_continuous}\hlstd{(}\hlkwc{limits} \hlstd{=} \hlkwd{range}\hlstd{(}\hlkwd{sqrt}\hlstd{(Wt}\hlopt{$}\hlstd{Kg)))} \hlopt{+}
        \hlkwd{geom_point}\hlstd{(}\hlkwc{data} \hlstd{= plotDF[plotDF}\hlopt{$}\hlstd{Kg} \hlopt{==} \hlnum{0}\hlstd{, ],} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Lon,}
            \hlkwc{y} \hlstd{= Lat),} \hlkwc{colour} \hlstd{=} \hlstr{"red"}\hlstd{,} \hlkwc{shape} \hlstd{=} \hlstr{"+"}\hlstd{)} \hlopt{+} \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Year,}
        \hlkwc{ncol} \hlstd{=} \hlnum{5}\hlstd{)} \hlopt{+} \hlkwd{theme_classic}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{"Spatial catches of"}\hlstd{,}
        \hlstd{spp[s],} \hlstr{"in Kg"}\hlstd{,} \hlkwc{sep} \hlstd{=} \hlstr{" "}\hlstd{)))}
\hlstd{\}}
\end{alltt}
\end{kframe}
\includegraphics[width=1\linewidth]{figure/Survey_catches-1} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-2} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-3} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-4} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-5} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-6} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-7} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-8} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-9} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-10} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-11} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-12} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-13} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-14} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-15} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-16} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-17} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-18} 

\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{Wt}\hlopt{$}\hlstd{HaulDur} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(}\hlkwd{as.character}\hlstd{(Wt}\hlopt{$}\hlstd{HaulDur))}

\hlstd{cpue} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Wt, Survey, Year, Species)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{q05} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{HaulDur} \hlopt{*}
    \hlnum{60}\hlstd{,} \hlkwc{prob} \hlstd{=} \hlnum{0.05}\hlstd{,} \hlkwc{na.rm} \hlstd{= T),} \hlkwc{q50} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{HaulDur} \hlopt{*}
    \hlnum{60}\hlstd{,} \hlkwc{prob} \hlstd{=} \hlnum{0.5}\hlstd{,} \hlkwc{na.rm} \hlstd{= T),} \hlkwc{mean} \hlstd{=} \hlkwd{mean}\hlstd{(Kg}\hlopt{/}\hlstd{HaulDur} \hlopt{*} \hlnum{60}\hlstd{,}
    \hlkwc{na.rm} \hlstd{= T),} \hlkwc{q95} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{HaulDur} \hlopt{*} \hlnum{60}\hlstd{,} \hlkwc{prob} \hlstd{=} \hlnum{0.95}\hlstd{,}
    \hlkwc{na.rm} \hlstd{= T))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(cpue,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= mean))} \hlopt{+} \hlkwd{geom_line}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{group} \hlstd{= Survey,}
    \hlkwc{colour} \hlstd{= Survey))} \hlopt{+} \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Species,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{scale} \hlstd{=} \hlstr{"free_y"}\hlstd{)} \hlopt{+}
    \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{"Kg per hour tow"}\hlstd{)} \hlopt{+}
    \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"CPUE (Kg per hour tow)"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=1\linewidth]{figure/CPUE-1} 
\begin{kframe}\begin{alltt}
\hlstd{cpsa} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Wt, Survey, Year, Species)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{q05} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{SweptArea,}
    \hlkwc{prob} \hlstd{=} \hlnum{0.05}\hlstd{,} \hlkwc{na.rm} \hlstd{= T),} \hlkwc{q50} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{SweptArea,} \hlkwc{prob} \hlstd{=} \hlnum{0.5}\hlstd{,}
    \hlkwc{na.rm} \hlstd{= T),} \hlkwc{mean} \hlstd{=} \hlkwd{mean}\hlstd{(Kg}\hlopt{/}\hlstd{SweptArea,} \hlkwc{na.rm} \hlstd{= T),} \hlkwc{q95} \hlstd{=} \hlkwd{quantile}\hlstd{(Kg}\hlopt{/}\hlstd{SweptArea,}
    \hlkwc{prob} \hlstd{=} \hlnum{0.95}\hlstd{,} \hlkwc{na.rm} \hlstd{= T))}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(cpsa,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Year,} \hlkwc{y} \hlstd{= mean))} \hlopt{+} \hlkwd{geom_line}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{group} \hlstd{= Survey,}
    \hlkwc{colour} \hlstd{= Survey))} \hlopt{+} \hlkwd{facet_wrap}\hlstd{(}\hlopt{~}\hlstd{Species,} \hlkwc{ncol} \hlstd{=} \hlnum{2}\hlstd{,} \hlkwc{scale} \hlstd{=} \hlstr{"free_y"}\hlstd{)} \hlopt{+}
    \hlkwd{theme}\hlstd{(}\hlkwc{axis.text.x} \hlstd{=} \hlkwd{element_text}\hlstd{(}\hlkwc{angle} \hlstd{=} \hlopt{-}\hlnum{90}\hlstd{))} \hlopt{+} \hlkwd{ylab}\hlstd{(}\hlstr{"Density (catch per km2 swept)"}\hlstd{)} \hlopt{+}
    \hlkwd{xlab}\hlstd{(}\hlstr{""}\hlstd{)} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"CPUE (Catch per km2 swept area)"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=1\linewidth]{figure/CPUE-2} 
\begin{kframe}\begin{alltt}
\hlcom{## Catchs per survey, per year}

\hlstd{Wt_Sur} \hlkwb{<-} \hlkwd{group_by}\hlstd{(Wt, Survey, Species)} \hlopt{%>%} \hlkwd{summarise}\hlstd{(}\hlkwc{wt} \hlstd{=} \hlkwd{sum}\hlstd{(Kg))}

\hlstd{Wt_Sur[Wt_Sur}\hlopt{$}\hlstd{wt} \hlopt{==} \hlnum{0}\hlstd{, ]}
\end{alltt}
\begin{verbatim}
## Source: local data frame [2 x 3]
## Groups: Survey [1]
## 
##       Survey               Species    wt
##       <fctr>                <fctr> <dbl>
## 1 CARLHELMAR      Gadus morhua_Juv     0
## 2 CARLHELMAR Lophius budegassa_Juv     0
\end{verbatim}
\begin{alltt}
\hlstd{Wt_Sur}\hlopt{$}\hlstd{wt[Wt_Sur}\hlopt{$}\hlstd{wt} \hlopt{==} \hlnum{0}\hlstd{]} \hlkwb{<-} \hlnum{NA}

\hlkwd{print}\hlstd{(}\hlkwd{ggplot}\hlstd{(Wt_Sur,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= Survey,} \hlkwc{y} \hlstd{= Species))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwd{aes}\hlstd{(}\hlkwc{size} \hlstd{=} \hlkwd{sqrt}\hlstd{(wt)))} \hlopt{+}
    \hlkwd{theme_classic}\hlstd{()} \hlopt{+} \hlkwd{ggtitle}\hlstd{(}\hlstr{"Catches of each species per survey"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=1\linewidth]{figure/CPUE-3} 

\end{knitrout}

\end{landscape}

It's apparent from the information that the CARLHELMAR survey area in the
Western Channel sees little catch of the gadoid species. This is perhaps
unsurprising given its designed as a flatfish survey. \\

The WCGFS, EVHOE, IE-IGFS and Q4SWIBTS show reasonable consistency with each
other in terms of CPUE trends for cod, though the WCGFS caught less haddock and
whiting. \\

\subsection{Conclusion on survey availability}

Having reviewed the available survey data, coverage prior to 1992 was patchy
and incomplete and the CARLHELMAR and NWGFS surveys are focused on flatfish
catches, with little information on gadoid species. Therefore it will be
important to check model diagnostics to entire the characteristics are being
treated appropriately. However, all the data will be kept for the first runs.\\

\section{Habitat covariates}

There is also the possibility to include habitat covariates in the model. In
order to explore this, two datasets were downloaded:

\begin{itemize}
	\item EU Sea Map Atlantic Habitat Classifications (from
		\url{http://www.emodnet-seabedhabitats.eu/}) which provides a
		substrate classification (e.g. rocky, sandy etc..) for the
		Celtic Sea area.
	\item Bathymetry data (from \url{http://www.emodnet-hydrography.eu/}
		which provides water depth.

\end{itemize}

The following function is used to assign the correct habitat location to the
knot locations generated by the VAST model. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HabAssignFunc} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{Kmeans} \hlstd{=} \hlkwa{NULL}\hlstd{,} \hlkwc{zone} \hlstd{=} \hlnum{29}\hlstd{,} \hlkwc{locationHabMap} \hlstd{=} \hlkwa{NULL}\hlstd{,}
    \hlkwc{nameHabMap} \hlstd{=} \hlkwa{NULL}\hlstd{) \{}
    \hlkwd{library}\hlstd{(rgdal)}
    \hlkwd{library}\hlstd{(VAST)}
    \hlcom{# Create a dataframe of the knots}
    \hlstd{DF} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{X} \hlstd{= Kmeans}\hlopt{$}\hlstd{centers[,} \hlstr{"E_km"}\hlstd{],} \hlkwc{Y} \hlstd{= Kmeans}\hlopt{$}\hlstd{centers[,}
        \hlstr{"N_km"}\hlstd{])}
    \hlkwd{attr}\hlstd{(DF,} \hlstr{"projection"}\hlstd{)} \hlkwb{=} \hlstr{"UTM"}
    \hlkwd{attr}\hlstd{(DF,} \hlstr{"zone"}\hlstd{)} \hlkwb{<-} \hlstd{zone}

    \hlstd{LLs} \hlkwb{<-} \hlstd{PBSmapping}\hlopt{::}\hlkwd{convUL}\hlstd{(DF)}

    \hlstd{HabMap} \hlkwb{<-} \hlkwd{readOGR}\hlstd{(}\hlkwc{dsn} \hlstd{=} \hlkwd{file.path}\hlstd{(locationHabMap),} \hlkwc{layer} \hlstd{= nameHabMap)}

    \hlcom{# joint the spatial points..}
    \hlstd{LLs} \hlkwb{<-} \hlkwd{SpatialPoints}\hlstd{(LLs)}
    \hlkwd{proj4string}\hlstd{(LLs)} \hlkwb{<-} \hlkwd{CRS}\hlstd{(}\hlstr{"+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"}\hlstd{)}

    \hlstd{join} \hlkwb{<-} \hlkwd{over}\hlstd{(}\hlkwc{x} \hlstd{= LLs,} \hlkwc{y} \hlstd{= HabMap)}

    \hlstd{LLs} \hlkwb{<-} \hlkwd{SpatialPointsDataFrame}\hlstd{(LLs, join)}
    \hlstd{KmeanHab} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{Habitat} \hlstd{= LLs}\hlopt{$}\hlstd{substrate)}

    \hlkwd{return}\hlstd{(KmeanHab)}

\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}


