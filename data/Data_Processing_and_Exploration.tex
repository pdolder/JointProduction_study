\documentclass[12pt]{article}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{times}
\usepackage{hyperref}
\usepackage{natbib}
\usepackage{amsmath}
\usepackage{fullpage}
\usepackage{pdflscape}
\usepackage{rotfloat}
\usepackage{listings}
\usepackage{wasysym}
\usepackage{wrapfig}
\usepackage{dcolumn}
\hypersetup{pdfpagemode=UseNone} % don't show bookmarks on initial view
\hypersetup{colorlinks, urlcolor={blue}}
% revise margins
\setlength{\headheight}{0.0in}
\setlength{\topmargin}{0.0in}
\setlength{\headsep}{0.0in}
\setlength{\textheight}{8.65in}
\setlength{\footskip}{0.35in}
\setlength{\oddsidemargin}{0.0in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textwidth}{6.5in}

\setlength{\parskip}{6pt}
\setlength{\parindent}{0pt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Processing and exploration for Celtic Sea fishery-independent trawl
	survey data}
\author{Paul J Dolder}
\date{\today}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}



\maketitle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This document is to detail the processing steps and workng up of data for fitting
a geostatistical model (VAST; see \url{https://github.com/james-thorson/VAST}
for detail) to trawl survey data covering the Celtic Sea. \\

The following data sources were used:

\begin{itemize}
	\item ICES Datras
		(\url{http://www.ices.dk/marine-data/data-portals/Pages/DATRAS.aspx}
		exhchange data of Ifremer (France) EVHOE and Marine Institute
		(Ireland) IGFS fisheries-independent survey locations and catch
		records.
	\item Cefas (UK) collection of trawl survey locations and catch
		records.
	\item ICES Datras data product on estimated weights of fish at various
		lengths from the EVHOE survey series.
\end{itemize}

\section{Length-weight conversion factors}

As the survey records consist of count of fish at each length class and we are
interested in working with biomass (weight) of fish, we first estimate a
length-weight relationship for the different species from the Datras data
product of weight at length estimates. The data is baseds on the EVHOE survey
series only, due to availability within Datras. \\

A standard von bertalanffy length weight relationship was used, with two
parameters to estimate:

\begin{equation}\label{eq:1}
	Wt = a \cdot L^b
\end{equation}

The raw data looks as follows for cod, megrim, anglerfishes, haddock, whiting,
hake, plaice and sole:

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{figure}
\includegraphics[width=\maxwidth]{figure/LWt-1} \caption[Estimates of individual weights at length for the gadoid species]{Estimates of individual weights at length for the gadoid species. Colours indicate individual years measurements}\label{fig:LWt}
\end{figure}


\end{knitrout}

To simplify the fitting procedure, the von bertalanffy relationship in equation
\ref{eq:1} was rearranged to be linear on a log scale:

\begin{equation}\label{eq:2}
	log(Wt) = log(a) + b \cdot log(L) + \varepsilon
\end{equation} 

\vspace{1cm}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figure/LWt2-1} 

\end{knitrout}

A linear model with species and year as factors was fit using the \textit{glm}
function in the base R package. We separate the roundfish and flatfish due to
the different morphological forms affecting the length weight relationship:

\begin{kframe}
\begin{alltt}
\hlstd{gads}  \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{'Gadus morhua'}\hlstd{,} \hlstr{'Melanogrammus aeglefinus'}\hlstd{,}
           \hlstr{'Merluccius merluccius'}\hlstd{,} \hlstr{'Merlangius merlangus'}\hlstd{)}
\hlstd{flats} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{'Lepidorhombus whiffiagonis'}\hlstd{,} \hlstr{'Solea solea'}\hlstd{,} \hlstr{'Pleuronectes platessa'}\hlstd{)}
\hlstd{lops}  \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{'Lophius piscatorius'}\hlstd{,} \hlstr{'Lophius budegassa'}\hlstd{)}

\hlstd{lm1.gad} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species} \hlopt{+} \hlstd{Year,}
               \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%} \hlstd{gads))}
\hlstd{lm2.gad} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species,}
               \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%} \hlstd{gads))}

\hlkwd{stargazer}\hlstd{(lm1.gad, lm2.gad,} \hlkwc{font.size}  \hlstd{=} \hlstr{'small'}\hlstd{,} \hlkwc{align} \hlstd{= T,}
          \hlkwc{title} \hlstd{=} \hlstr{'glm output from the two model fits to gadoids'}\hlstd{,}
          \hlkwc{table.placement} \hlstd{=} \hlstr{'H'}\hlstd{)}
\end{alltt}
\end{kframe}
% Table created by stargazer v.5.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: Tue, Jan 24, 2017 - 11:48:18
% Requires LaTeX packages: dcolumn 
\begin{table}[H] \centering 
  \caption{glm output from the two model fits to gadoids} 
  \label{} 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lD{.}{.}{-3} D{.}{.}{-3} } 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{lWt} \\ 
\\[-1.8ex] & \multicolumn{1}{c}{(1)} & \multicolumn{1}{c}{(2)}\\ 
\hline \\[-1.8ex] 
 lL & 3.085^{***} & 3.085^{***} \\ 
  & (0.005) & (0.005) \\ 
  & & \\ 
 SpeciesMelanogrammus aeglefinus & -0.015^{**} & -0.015^{**} \\ 
  & (0.007) & (0.007) \\ 
  & & \\ 
 SpeciesMerlangius merlangus & -0.199^{***} & -0.199^{***} \\ 
  & (0.008) & (0.008) \\ 
  & & \\ 
 SpeciesMerluccius merluccius & -0.435^{***} & -0.436^{***} \\ 
  & (0.149) & (0.149) \\ 
  & & \\ 
 Year & 0.0001 &  \\ 
  & (0.001) &  \\ 
  & & \\ 
 Constant & -12.263^{***} & -11.977^{***} \\ 
  & (1.607) & (0.034) \\ 
  & & \\ 
\hline \\[-1.8ex] 
Observations & \multicolumn{1}{c}{6,624} & \multicolumn{1}{c}{6,624} \\ 
Log Likelihood & \multicolumn{1}{c}{3,219.649} & \multicolumn{1}{c}{3,219.633} \\ 
Akaike Inf. Crit. & \multicolumn{1}{c}{-6,427.297} & \multicolumn{1}{c}{-6,429.266} \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 
\begin{kframe}\begin{alltt}
\hlstd{lm1.flat} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species} \hlopt{+} \hlstd{Year,}
                \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%} \hlstd{flats    ))}
\hlstd{lm2.flat} \hlkwb{<-} \hlkwd{glm}\hlstd{(lWt} \hlopt{~} \hlstd{lL} \hlopt{+} \hlstd{Species,}
                \hlkwc{data} \hlstd{=} \hlkwd{filter}\hlstd{(DF, Species} \hlopt{%in%} \hlstd{flats))}

\hlkwd{stargazer}\hlstd{(lm1.flat, lm2.flat,} \hlkwc{font.size}  \hlstd{=} \hlstr{'small'}\hlstd{,} \hlkwc{align} \hlstd{= T,}
          \hlkwc{title} \hlstd{=} \hlstr{'glm output from the two model fits to flatfish'}\hlstd{,}
          \hlkwc{table.placement} \hlstd{=} \hlstr{'H'}\hlstd{)}
\end{alltt}
\end{kframe}
% Table created by stargazer v.5.2 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu
% Date and time: Tue, Jan 24, 2017 - 11:48:18
% Requires LaTeX packages: dcolumn 
\begin{table}[H] \centering 
  \caption{glm output from the two model fits to flatfish} 
  \label{} 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lD{.}{.}{-3} D{.}{.}{-3} } 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{lWt} \\ 
\\[-1.8ex] & \multicolumn{1}{c}{(1)} & \multicolumn{1}{c}{(2)}\\ 
\hline \\[-1.8ex] 
 lL & 3.106^{***} & 3.106^{***} \\ 
  & (0.010) & (0.010) \\ 
  & & \\ 
 SpeciesPleuronectes platessa & 0.361^{***} & 0.358^{***} \\ 
  & (0.013) & (0.012) \\ 
  & & \\ 
 SpeciesSolea solea & 0.190^{***} & 0.188^{***} \\ 
  & (0.009) & (0.009) \\ 
  & & \\ 
 Year & -0.001 &  \\ 
  & (0.002) &  \\ 
  & & \\ 
 Constant & -9.739^{***} & -12.410^{***} \\ 
  & (3.147) & (0.056) \\ 
  & & \\ 
\hline \\[-1.8ex] 
Observations & \multicolumn{1}{c}{3,180} & \multicolumn{1}{c}{3,180} \\ 
Log Likelihood & \multicolumn{1}{c}{753.089} & \multicolumn{1}{c}{752.728} \\ 
Akaike Inf. Crit. & \multicolumn{1}{c}{-1,496.177} & \multicolumn{1}{c}{-1,497.456} \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 


Year was initially also included as a factor, but found not to be significant
and the second, across year, fit was chosen as the best models (Table 1, Table
2). These models were then used to predict over all lengths for each species.  A
bias correction was applied to adjust for the fact that the mean weights from
the model fit on a log scale are geometric means on the normal scale (cf =
$e^{\frac{\sigma^{2}}{2}}$).

For anglerfish, as there is insufficient data for a fit a model (few data
points for piscatorius, no data points for budegassa), we use estimates from
fishbase: $a = 0.03330$, $b= 2.766$.



\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Exponentiate the predictions}
\hlstd{predDF}\hlopt{$}\hlstd{L}  \hlkwb{<-} \hlkwd{exp}\hlstd{(predDF}\hlopt{$}\hlstd{lL)}
\hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlkwd{c}\hlstd{(gads,flats)]} \hlkwb{<-} \hlkwd{exp}\hlstd{(predDF}\hlopt{$}\hlstd{lWt[predDF}\hlopt{$}\hlstd{Species}
                                                    \hlopt{%in%} \hlkwd{c}\hlstd{(gads, flats)])}

\hlcom{## Now we need to bias correct due to the fact that the mean on the logscale is}
\hlcom{## the geometric mean...}
\hlstd{corr.fact.gad}  \hlkwb{<-} \hlkwd{exp}\hlstd{(}\hlkwd{sigma}\hlstd{(lm2.gad)}\hlopt{^}\hlnum{2}\hlopt{/}\hlnum{2}\hlstd{)}
\hlstd{corr.fact.flat} \hlkwb{<-} \hlkwd{exp}\hlstd{(}\hlkwd{sigma}\hlstd{(lm2.flat)}\hlopt{^}\hlnum{2}\hlopt{/}\hlnum{2}\hlstd{)}
\hlkwd{print}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{'Correction factor for gadoids='}\hlstd{,}\hlkwd{round}\hlstd{(corr.fact.gad,}\hlnum{3}\hlstd{),}
            \hlstr{'and flats = '}\hlstd{,} \hlkwd{round}\hlstd{(corr.fact.flat,}\hlnum{3}\hlstd{)))}
\end{alltt}
\begin{verbatim}
## [1] "Correction factor for gadoids= 1.011 and flats =  1.018"
\end{verbatim}
\begin{alltt}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]}  \hlkwb{<-} \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{gads]}\hlopt{*}
        \hlstd{corr.fact.gad}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]} \hlkwb{<-} \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{flats]}\hlopt{*}
        \hlstd{corr.fact.flat}
\hlstd{predDF}\hlopt{$}\hlstd{WtCorr[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]} \hlkwb{<-}  \hlstd{predDF}\hlopt{$}\hlstd{Wt[predDF}\hlopt{$}\hlstd{Species} \hlopt{%in%} \hlstd{lops]}

\hlcom{# Plot the von bertalanffy fits}
\hlkwd{ggplot}\hlstd{(DF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= LngtClass,} \hlkwc{y} \hlstd{= IndWgt))} \hlopt{+} \hlkwd{geom_point}\hlstd{(}\hlkwc{colour} \hlstd{=} \hlstr{'grey'}\hlstd{)} \hlopt{+}
        \hlkwd{facet_wrap}\hlstd{(}\hlopt{~} \hlstd{Species,} \hlkwc{scale} \hlstd{=} \hlstr{'free'}\hlstd{)} \hlopt{+}
        \hlkwd{geom_line}\hlstd{(}\hlkwc{data} \hlstd{= predDF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= L,} \hlkwc{y} \hlstd{= Wt),} \hlkwc{col} \hlstd{=} \hlstr{'red'}\hlstd{)} \hlopt{+}
        \hlkwd{geom_line}\hlstd{(}\hlkwc{data} \hlstd{= predDF,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= L,} \hlkwc{y} \hlstd{= WtCorr),} \hlkwc{col} \hlstd{=} \hlstr{'blue'}\hlstd{)} \hlopt{+}
        \hlkwd{theme_bw}\hlstd{()}
\end{alltt}
\end{kframe}
\includegraphics[width=\maxwidth]{figure/Predictions2-1} 
\begin{kframe}\begin{alltt}
\hlstd{lm2} \hlkwb{<-} \hlkwd{list}\hlstd{(lm2.gad, lm2.flat)}
\hlstd{corr.fact} \hlkwb{<-} \hlkwd{list}\hlstd{(corr.fact.gad, corr.fact.flat)}

\hlcom{## Save the fit and the correction factor}
\hlkwd{save}\hlstd{(lm2, corr.fact, lop,} \hlkwc{file} \hlstd{=} \hlkwd{file.path}\hlstd{(}\hlstr{'DATRAS'}\hlstd{,}\hlstr{'LengthWeightPredictCelticSea.RData'}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}

\section{DATRAS data processing}

Next the ICES Datras database was queried for all survey data from the Celtic
Sea, extracting the haul data with the function \textit{getHHdata} and the
catch data using the function \textit{getHLdata} from the package
\textit{icesDatras}. \\

The objective was to check, clean and format the data into suitable input data
for the VAST model. For the Datras data this involved:

\begin{itemize}
	\item Only retain valid hauls (excluding those at night, where there
		were problems with the gear etc..)
	\item As we want point data, calculate the midpoint of each tow based
		on the geodesic distance (also estimating any missing data on
		distance towed).
	\item In order to calculate swept area, obtain model estimates for any
		missing data points on door spread through modelling the
		relationship between depth and door spread.
	\item Calculate swept area for each tow in the surveys.
	\item Estimate weight at length using the length weight relationship
		predictions obtained from equation \ref{eq:1} above.
	\item Raise the data to weight, partioned between adult and juvenile fish.
	\item Merge station and catch data ensuring there is one record per
		species for each of the stations fished (including where there
		were zero catches).
\end{itemize}

\subsection{Midpoint of tows}

To calculate the tow midpoints, we assume tows are in a straight line and use
the haversine formula (based on location in radians) to calculate the total distance.

\begin{equation}
	Loc(R) = Loc(D) \cdot \frac{\pi}{180}
\end{equation}

Where R and D are radians and decimal degrees respectively. \\

To calculate the distance:

\begin{equation}
	\begin{split}
	& f D(km) = \\
	& R \cdot \Bigg[2 \cdot \arcsin \Bigg(\min\bigg(1,
	\sqrt{\sin({\frac{Lat_{y1} - Lat_{y2}}{2}})^2 + \cos(Lat_{x1}) \cdot
		\cos(Lat_{x2}) \cdot \sin({\frac{Lon_{x1} -
				Lon_{x2}}{2})^2}}\bigg)\Bigg)\Bigg]
\end{split}
\end{equation}

Where $R$ is the mean Radius of the Earth, 6 341 km. \\

Total records were: \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\begin{tabular}{l|l|r}
\hline
Survey & HaulVal & n\\
\hline
EVHOE & I & 2\\
\hline
EVHOE & V & 2643\\
\hline
IE-IGFS & V & 2118\\
\hline
\end{tabular}


\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HH}\hlopt{$}\hlstd{Dist} \hlkwb{<-} \hlkwd{mapply}\hlstd{(gcd.hf,} \hlkwc{long1} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLong)),}
                 \hlkwc{lat1}  \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{ShootLat)),}
                 \hlkwc{long2} \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLong)),}
                 \hlkwc{lat2}  \hlstd{=} \hlkwd{deg2rad}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{HaulLat)))}

\hlkwd{plot}\hlstd{(}\hlkwd{an}\hlstd{(HH}\hlopt{$}\hlstd{Distance[(HH}\hlopt{$}\hlstd{Distance} \hlopt{!= -}\hlnum{9}\hlstd{)])}\hlopt{/}\hlnum{1000} \hlopt{~} \hlstd{HH}\hlopt{$}\hlstd{Dist[(HH}\hlopt{$}\hlstd{Distance} \hlopt{!= -}\hlnum{9}\hlstd{)],}
     \hlkwc{main} \hlstd{=} \hlstr{'Recorded vs calculated distance'}\hlstd{,}
     \hlkwc{ylab}\hlstd{=}\hlstr{'Recorded distance'}\hlstd{,} \hlkwc{xlab} \hlstd{=} \hlstr{'Calculated distance'}\hlstd{,} \hlkwc{cex} \hlstd{=} \hlnum{0.7}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/Distances2-1} 

}


\begin{kframe}\begin{alltt}
\hlcom{## Looks good - use the calculated estimates ##}
\end{alltt}
\end{kframe}
\end{knitrout}

\subsection{Swept area}

To calculate the swept area, we first have to estimate the door spread for any
records where it's missing. There were only 5 records with missing door spread,
but use the predicted door spread for all records. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/DoorSpread-1} 

}



\end{knitrout}

There may be another covariate affecting doorspread, indicated by the
clustering of some of the data...lets look at some of them.

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/DoorSpread2-1} 

}



\end{knitrout}

There looks to be a relationship between depth and doorspread where it
increases to around 200 m and then flattens out, but with a covariate effect.
We will model this relationship with a gam. 

\begin{kframe}
\begin{alltt}
\hlcom{# Without covariate}
\hlstd{m1} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlstd{Depth,} \hlkwc{data} \hlstd{= HH)}
\hlcom{#summary(m1)}

\hlcom{# With all covariate, no interactions}
\hlstd{m2} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlstd{Depth} \hlopt{+} \hlkwd{factor}\hlstd{(DoorWgt)} \hlopt{+} \hlstd{Warplngt} \hlopt{+}
          \hlkwd{factor}\hlstd{(Warpdia)} \hlopt{+} \hlkwd{factor}\hlstd{(SweepLngt),} \hlkwc{data} \hlstd{=   HH)}
\hlcom{#summary(m2)}

\hlcom{### full interactions}
\hlstd{m3} \hlkwb{<-} \hlkwd{gam}\hlstd{(DoorSpread} \hlopt{~} \hlstd{Depth} \hlopt{*} \hlkwd{factor}\hlstd{(DoorWgt)} \hlopt{*} \hlstd{Warplngt} \hlopt{*}
          \hlkwd{factor}\hlstd{(Warpdia)} \hlopt{*} \hlkwd{factor}\hlstd{(SweepLngt),} \hlkwc{data} \hlstd{=   HH)}
\hlcom{#summary(m3)}
\end{alltt}
\end{kframe}


\begin{tabular}{l|r|r}
\hline
  & df & AIC\\
\hline
m1 & 3 & 32243.81\\
\hline
m2 & 8 & 25152.74\\
\hline
m3 & 25 & 24263.96\\
\hline
\end{tabular}



Full model looks best, but let's check the residuals against the covariates
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Residualcheck-1} 

}




{\centering \includegraphics[width=\maxwidth]{figure/Residualcheck-2} 

}



\end{knitrout}

Residuals look OK, so let's check the predictions against the measurements...

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Doorspread3-1} 

}



\end{knitrout}

Looks OK.  We use this to predict the door spread for the tows. Then, we calculate
swept area based on:

\begin{equation}
	Swept Area (km^2) = Distance (km) \cdot \frac{Doorspread (m)}{1000}
	\cdot CF 
\end{equation}

Where CF is a correction factor for the efficiency of the gear, taken from Piet
et al as 0.38 for otter trawl gears. \textcolor{red}{ADD REF}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/SweptArea-1} 

}



\end{knitrout}

\subsection{Converting to weight}

The length data were converted to weight through the following process:

\begin{itemize}
	\item Standardise unit of measurement to cm
	\item Add .5cm to each length group to reflect the fact that lengths
		are rounded down on measurement.
	\item Adjusting one outlier (a single whiting of 2.5 m, an order
		greater than actual length) 
	\item Predict weights from the length weight relationships obtained
		above using equation \ref{eq:1}.
	\item Multiply the number caught at length by the subfactor (fraction
		measured at length from the haul) and by the predicted weight
		at length, converting to KG.
	\item Relabel the species to reflect if they are juvenile or adult
		length. The lengths to define this split were based on the EU
		technical regulation defining the minimum conservation
		reference size (MCRS); for cod = 35 cm, haddock = 30 cm,
		whiting = 27 cm, hake = 27 cm, plaice = 27 cm, sole = 24 cm,
		megrim = 20 cm. For anglerfishes (piscatorius and budegassa) at
		value of 32 cm was used, equivalent to the 500 g minimum
		marketing weight.
	\item Aggregate across length classes by species.
	\item Merge the station information with the catch records, retaining
		zero entries for each species at each station, where
		appropriate.
	\item Retaining all stations within 12 W - 2 W \&  48 N - 52 N (the
		Celtic Sea area).
\end{itemize}

The output from an estimation of the length at minimum marketing size for
anglerfishes was as follows:

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{verbatim}
FALSE $root
FALSE [1] 32.35575
FALSE 
FALSE $f.root
FALSE [1] 1.712325e-07
FALSE 
FALSE $iter
FALSE [1] 10
FALSE 
FALSE $init.it
FALSE [1] NA
FALSE 
FALSE $estim.prec
FALSE [1] 6.103516e-05
FALSE [1] 0.5000002
\end{verbatim}
\end{kframe}

{\centering \includegraphics[width=\maxwidth]{figure/AddingWeights-1} 

}


\begin{kframe}

{\ttfamily\noindent\itshape\color{messagecolor}{FALSE Joining, by = c("{}Survey"{}, "{}Quarter"{}, "{}Country"{}, "{}Ship"{}, "{}Gear"{}, "{}StNo"{}, "{}HaulNo"{}, "{}Year"{}, "{}SpeciesName"{})}}\end{kframe}
\end{knitrout}

\section{Cefas survey data}

The same process was undergone for the Cefas survey data. The only differences
were:

\begin{itemize}
	\item 12 040 tows were recorded as valid, with 677 either recorded
		invalid, abnormal or otherwise classified as irregular.
	\item Due to some abnormally large tow distances, a standardised tow
		distance (per 60 m ) was calculated, and a Median Absolute
		Deviation (MAD) per survey series, with only standardised tow
		distances +- 5 times the value kept. This removed 578 outlier
		tows (keeping 9022).
	\item Swept Area sometimes reflected the use of a single or double beam
		trawl.
	\item The correction factor used was either an otter trawl value of
		0.38 (as above) or a beam trawl value of 0.19, as appropriate.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Exploratory plots}

The following section details some exploratory plots from the cleaned data.
This guides the final dataset used to fit the VAST model.




\subsection{Survey locations}

The following figure shows the surveys locations each year, with each survey
coloured differently.\\

As can be seen, initially (1982 - 1985) survey coverage was sparse and
irregular, only covered by the Cefas WCGFS. From 1986 this survey becomes more
regular and established, but is discontinued in 2003. The NWGFS beam trawl
survey was added in 1988 and the CARLHELMAR beam trawl survey covered the
western channel from 1989 until 2013.\\

The next significant change is the addition of the EVHOE survey in 1997,
followed by the IE-IGFS survey and the Q1SWIBTS in 2003 (with the latter
discontinuing in 2010). Finally, the Q1SWBEAM is added around 2006. \\

It is worth noting that the ICES cod and whiting assessments use a truncated
survey series from the WCGFS, only using 1992 - 2004 due to changes in survey
area and concerns about its impact on selectivity. \\

\begin{landscape}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=1\linewidth]{figure/Survey_locations-1} 

\end{knitrout}

\end{landscape}

\subsection{Survey temporal coverage}

The following table and plots detail the temporal coverage of the surveys. As
can be seen, the number of stations was initially low (< 100) but increased to
> 200 by 1997.\\

The majority of survey effort is in the fourth quarter, though some survey
effort is also undertaken in the first quarter

The majority of survey effort is in the fourth quarter, though some survey
effort is also undertaken in the first quarter. \\ 

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\begin{tabular}{l|r|r|r|r|r|r|r}
\hline
  & CARLHELMAR & EVHOE & IE-IGFS & NWGFS & Q1SWBEAM & Q4SWIBTS & WCGFS\\
\hline
1982 & 0 & 0 & 0 & 0 & 0 & 0 & 59\\
\hline
1983 & 0 & 0 & 0 & 0 & 0 & 0 & 32\\
\hline
1984 & 0 & 0 & 0 & 0 & 0 & 0 & 52\\
\hline
1985 & 0 & 0 & 0 & 0 & 0 & 0 & 84\\
\hline
1986 & 0 & 0 & 0 & 0 & 0 & 0 & 77\\
\hline
1987 & 0 & 0 & 0 & 0 & 0 & 0 & 88\\
\hline
1988 & 0 & 0 & 0 & 21 & 0 & 0 & 105\\
\hline
1989 & 52 & 0 & 0 & 51 & 0 & 0 & 52\\
\hline
1990 & 54 & 0 & 0 & 20 & 0 & 0 & 52\\
\hline
1991 & 50 & 0 & 0 & 32 & 0 & 0 & 100\\
\hline
1992 & 54 & 0 & 0 & 34 & 0 & 0 & 111\\
\hline
1993 & 55 & 0 & 0 & 105 & 0 & 0 & 55\\
\hline
1994 & 57 & 0 & 0 & 95 & 0 & 0 & 31\\
\hline
1995 & 53 & 0 & 0 & 57 & 0 & 0 & 54\\
\hline
1996 & 57 & 0 & 0 & 81 & 0 & 0 & 53\\
\hline
1997 & 52 & 46 & 0 & 86 & 0 & 0 & 64\\
\hline
1998 & 58 & 55 & 0 & 69 & 0 & 0 & 63\\
\hline
1999 & 56 & 56 & 0 & 40 & 0 & 0 & 64\\
\hline
2000 & 56 & 47 & 0 & 33 & 0 & 0 & 64\\
\hline
2001 & 51 & 76 & 0 & 37 & 0 & 0 & 59\\
\hline
2002 & 70 & 73 & 0 & 43 & 0 & 0 & 62\\
\hline
2003 & 128 & 72 & 49 & 43 & 0 & 35 & 48\\
\hline
2004 & 72 & 62 & 54 & 41 & 0 & 52 & 57\\
\hline
2005 & 59 & 67 & 60 & 41 & 0 & 40 & 0\\
\hline
2006 & 58 & 59 & 71 & 43 & 61 & 18 & 0\\
\hline
2007 & 58 & 70 & 77 & 41 & 64 & 38 & 0\\
\hline
2008 & 53 & 65 & 74 & 36 & 68 & 37 & 0\\
\hline
2009 & 55 & 59 & 64 & 43 & 63 & 32 & 0\\
\hline
2010 & 57 & 59 & 81 & 41 & 81 & 42 & 0\\
\hline
2011 & 57 & 71 & 86 & 40 & 80 & 39 & 0\\
\hline
2012 & 54 & 56 & 85 & 42 & 80 & 0 & 0\\
\hline
2013 & 58 & 63 & 83 & 42 & 127 & 0 & 0\\
\hline
2014 & 0 & 69 & 84 & 43 & 86 & 0 & 0\\
\hline
2015 & 0 & 62 & 68 & 43 & 126 & 0 & 0\\
\hline
2016 & 0 & 0 & 0 & 0 & 132 & 0 & 0\\
\hline
\end{tabular}



{\centering \includegraphics[width=\maxwidth]{figure/Survey_by_year-1} 

}



\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_by_month-1} 

}



\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_effort_by_year-1} 

}



\end{knitrout}

The surveys are using different gears. The main difference being that the
WCGFS, IE-IGFS, EVHOE and WCGFS use otter trawl gears, while the CARLHELMAR,
NWGFS, Q1SWBEAM use beam trawl gears. The WCGFS initially used hour long tows,
but changes to 30 min tows consistent with other surveys later in the series. \\ 

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_swept_area-1} 

}




{\centering \includegraphics[width=\maxwidth]{figure/Survey_swept_area-2} 

}



\end{knitrout}

The following plots show the minimum, maximum and mean (red points) survey
latitude and longitude per year, to explore changes in survey coverage. \\

The longitude max and min has broadly been at -2.5 to -12 for the time series,
though has been more consistent since 1990. The addition of the CARLHELMAR
survey in 1988 shifted the mean survey location eastwards, from around -8 to -5
degrees. \\

The latitudinal max and min has also generally been from 48 to 52 degrees over
the time series, though this has been more consistent since 1996. The mean has
generally been around 51 degrees.


\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/Survey_Spatial_extent-1} 

}




{\centering \includegraphics[width=\maxwidth]{figure/Survey_Spatial_extent-2} 

}



\end{knitrout}


The following details the total catch by year, by survey. As can be seen, the
IE-IGFS, EVHOE, WCGFS, Q4SWIBTS and Q1SWBEAM catch reasonable quantities of
gadoids, while the CARLHELMAR and NWGFS catch very little. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}

{\centering \includegraphics[width=\maxwidth]{figure/TotalCatch-1} 

}



\end{knitrout}

The next pages detail the spatial catch distribution of the different species,
followed by the catch per unit effort for the different survey series for each
species. 

\begin{landscape}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=1\linewidth]{figure/Survey_catches-1} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-2} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-3} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-4} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-5} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-6} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-7} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-8} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-9} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-10} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-11} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-12} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-13} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-14} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-15} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-16} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-17} 

\includegraphics[width=1\linewidth]{figure/Survey_catches-18} 

\end{knitrout}

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=1\linewidth]{figure/CPUE-1} 

\includegraphics[width=1\linewidth]{figure/CPUE-2} 

\end{knitrout}

\end{landscape}

It's apparent from the information that the CARLHELMAR survey area in the
Western Channel sees little catch of the gadoid species. This is perhaps
unsurprising given its designed as a flatfish survey. \\

The WCGFS, EVHOE, IE-IGFS and Q4SWIBTS show reasonable consistency with each
other in terms of CPUE trends for cod, though the WCGFS caught less haddock and
whiting. \\

\subsection{Conclusion on survey availability}

Having reviewed the available survey data, coverage prior to 1992 was patchy
and incomplete and the CARLHELMAR and NWGFS surveys are focused on flatfish
catches, with little information on gadoid species. Therefore it will be
important to check model diagnostics to entire the characteristics are being
treated appropriately. However, all the data will be kept for the first runs.\\

\section{Habitat covariates}

There is also the possibility to include habitat covariates in the model. In
order to explore this, two datasets were downloaded:

\begin{itemize}
	\item EU Sea Map Atlantic Habitat Classifications (from
		\url{http://www.emodnet-seabedhabitats.eu/}) which provides a
		substrate classification (e.g. rocky, sandy etc..) for the
		Celtic Sea area.
	\item Bathymetry data (from \url{http://www.emodnet-hydrography.eu/}
		which provides water depth.

\end{itemize}

The following function is used to assign the correct habitat location to the
knot locations generated by the VAST model. \\

\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{HabAssignFunc} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{Kmeans} \hlstd{=} \hlkwa{NULL}\hlstd{,} \hlkwc{zone} \hlstd{=} \hlnum{29}\hlstd{,} \hlkwc{locationHabMap} \hlstd{=} \hlkwa{NULL}\hlstd{,}
                          \hlkwc{nameHabMap} \hlstd{=} \hlkwa{NULL}\hlstd{) \{}
\hlkwd{library}\hlstd{(rgdal)}
\hlkwd{library}\hlstd{(VAST)}
\hlcom{# Create a dataframe of the knots}
\hlstd{DF} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{X} \hlstd{= Kmeans}\hlopt{$}\hlstd{centers[,}\hlstr{'E_km'}\hlstd{],} \hlkwc{Y} \hlstd{= Kmeans}\hlopt{$}\hlstd{centers[,}\hlstr{'N_km'}\hlstd{])}
\hlkwd{attr}\hlstd{(DF,} \hlstr{'projection'}\hlstd{)} \hlkwb{=} \hlstr{'UTM'}
\hlkwd{attr}\hlstd{(DF,} \hlstr{"zone"}\hlstd{)} \hlkwb{<-} \hlstd{zone}

\hlstd{LLs} \hlkwb{<-} \hlstd{PBSmapping}\hlopt{::}\hlkwd{convUL}\hlstd{(DF)}

\hlstd{HabMap} \hlkwb{<-} \hlkwd{readOGR}\hlstd{(}\hlkwc{dsn} \hlstd{=} \hlkwd{file.path}\hlstd{(locationHabMap),} \hlkwc{layer} \hlstd{= nameHabMap)}

\hlcom{# joint the spatial points..}
\hlstd{LLs} \hlkwb{<-} \hlkwd{SpatialPoints}\hlstd{(LLs)}
\hlkwd{proj4string}\hlstd{(LLs)} \hlkwb{<-}
        \hlkwd{CRS}\hlstd{(}\hlstr{'+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'}\hlstd{)}

\hlstd{join} \hlkwb{<-} \hlkwd{over}\hlstd{(}\hlkwc{x} \hlstd{= LLs,} \hlkwc{y} \hlstd{= HabMap)}

\hlstd{LLs} \hlkwb{<-} \hlkwd{SpatialPointsDataFrame}\hlstd{(LLs, join)}
\hlstd{KmeanHab} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{Habitat} \hlstd{= LLs}\hlopt{$}\hlstd{substrate)}

\hlkwd{return}\hlstd{(KmeanHab)}

\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}


